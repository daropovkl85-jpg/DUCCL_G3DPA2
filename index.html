<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>·ûú·üÅ·ûì·ûü·ûò·üí·û¢·û∂·ûè·ûü·û∂·ûõ·û∂ ·ûá·üÜ·ûì·û∂·ûì·üã3 DPA2</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- HTML2PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- ExcelJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, update } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAJW7lYgDEr5eqAlJy26ZYoyJWZobJnsU0",
            authDomain: "duccleaner.firebaseapp.com",
            projectId: "duccleaner",
            databaseURL: "https://duccleaner-default-rtdb.asia-southeast1.firebasedatabase.app/", 
            storageBucket: "duccleaner.firebasestorage.app",
            messagingSenderId: "166864480178",
            appId: "1:166864480178:web:9f8aedfdd0135f887fe6ab",
            measurementId: "G-K2TQHHPJ17"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const db = getDatabase(app);

            window.db = db;
            window.rdbRef = ref;
            window.rdbSet = set;
            window.rdbUpdate = update;
            window.rdbOnValue = onValue;
            console.log("Firebase initialized successfully");
        } catch (err) {
            console.error("Firebase Init Error:", err);
        }
    </script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@300;400;500;600;700&family=Noto+Sans+Khmer:wght@300;400;500;600;700&family=Moul&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Noto Sans Khmer', sans-serif; 
            background-color: #f3f4f6;
        }
        .font-display { font-family: 'Kantumruy Pro', sans-serif; }
        .font-header { font-family: 'Moul', serif; }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }

        /* Custom Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            transition: all 0.2s ease;
        }
        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
        }

        /* Print styles */
        @media print {
            @page { size: A4; margin: 0; }
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; background: white; }
            .no-print { display: none !important; }
            .glass-panel, .glass-card { background: white; border: none; box-shadow: none; backdrop-filter: none; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 min-h-screen text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- ICONS ---
        const Icon = ({ children, size = 20, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Calendar = (p) => <Icon {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></Icon>;
        const UserCheck = (p) => <Icon {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><polyline points="16 11 18 13 22 9"/></Icon>;
        const UserX = (p) => <Icon {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="17" x2="22" y1="8" y2="13"/><line x1="22" x2="17" y1="8" y2="13"/></Icon>;
        const Clock = (p) => <Icon {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></Icon>;
        const Copy = (p) => <Icon {...p}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></Icon>;
        const Search = (p) => <Icon {...p}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></Icon>;
        const Trash2 = (p) => <Icon {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></Icon>;
        const ChevronLeft = (p) => <Icon {...p}><path d="m15 18-6-6 6-6"/></Icon>;
        const ChevronRight = (p) => <Icon {...p}><path d="m9 18 6-6-6-6"/></Icon>;
        const Filter = (p) => <Icon {...p}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></Icon>;
        const CheckCircle2 = (p) => <Icon {...p}><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></Icon>;
        const AlertCircle = (p) => <Icon {...p}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></Icon>;
        const Users = (p) => <Icon {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></Icon>;
        const BarChart3 = (p) => <Icon {...p}><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></Icon>;
        const LayoutDashboard = (p) => <Icon {...p}><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></Icon>;
        const Download = (p) => <Icon {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></Icon>;
        const FileBarChart = (p) => <Icon {...p}><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M8 13h2"/><path d="M12 17v-4"/><path d="M16 17v-2"/></Icon>;
        const FileSpreadsheet = (p) => <Icon {...p}><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M8 13h2"/><path d="M14 13h2"/><path d="M8 17h2"/><path d="M14 17h2"/></Icon>;
        const Sparkles = (p) => <Icon {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 9h4"/><path d="M3 5h4"/></Icon>;

        // --- GLOBAL HELPERS ---
        const formatDateToKhmer = (date, full = false) => {
            const months = ["·ûò·ûÄ·ûö·û∂", "·ûÄ·ûª·ûò·üí·ûó·üà", "·ûò·û∏·ûì·û∂", "·ûò·üÅ·ûü·û∂", "·ûß·ûü·ûó·û∂", "·ûò·û∑·ûê·ûª·ûì·û∂", "·ûÄ·ûÄ·üí·ûÄ·ûä·û∂", "·ûü·û∏·û†·û∂", "·ûÄ·ûâ·üí·ûâ·û∂", "·ûè·ûª·ûõ·û∂", "·ûú·û∑·ûÖ·üí·ûÜ·û∑·ûÄ·û∂", "·ûí·üí·ûì·ûº"];
            const days = ["·û¢·û∂·ûë·û∑·ûè·üí·ûô", "·ûÖ·ûì·üí·ûë", "·û¢·ûÑ·üí·ûÇ·û∂·ûö", "·ûñ·ûª·ûí", "·ûñ·üí·ûö·û†·ûü·üí·ûî·ûè·û∑·üç", "·ûü·ûª·ûÄ·üí·ûö", "·ûü·üÖ·ûö·üç"];
            const toKhmerNum = (num) => num.toString().replace(/\d/g, d => '·ü†·ü°·ü¢·ü£·ü§·ü•·ü¶·üß·ü®·ü©'[d]);
            
            if (full) return `·ûê·üí·ûÑ·üÉ${days[date.getDay()]} ·ûë·û∏${toKhmerNum(date.getDate())} ·ûÅ·üÇ${months[date.getMonth()]} ·ûÜ·üí·ûì·û∂·üÜ${toKhmerNum(date.getFullYear())}`;
            return `·ûÅ·üÇ${months[date.getMonth()]} ·ûÜ·üí·ûì·û∂·üÜ${toKhmerNum(date.getFullYear())}`;
        };

        const getWeeksOfMonth = (date) => {
            const year = date.getFullYear();
            const month = date.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const weeks = [];
            let currentWeekStart = firstDay;
            let weekNumber = 1;

            while (currentWeekStart <= lastDay) {
                let currentWeekEnd = new Date(currentWeekStart);
                const dayOfWeek = currentWeekStart.getDay();
                const daysUntilSunday = dayOfWeek === 0 ? 0 : 7 - dayOfWeek;
                currentWeekEnd.setDate(currentWeekStart.getDate() + daysUntilSunday);
                if (currentWeekEnd > lastDay) currentWeekEnd = lastDay;

                const startStr = `${currentWeekStart.getDate()}`;
                const endStr = `${currentWeekEnd.getDate()} ${formatDateToKhmer(currentWeekEnd).split(' ')[0]}`;
                weeks.push({ id: weekNumber, label: `·ûü·ûî·üí·ûä·û∂·û†·üç·ûë·û∏ ${weekNumber}`, range: `${startStr} - ${endStr}` });
                currentWeekStart = new Date(currentWeekEnd);
                currentWeekStart.setDate(currentWeekStart.getDate() + 1);
                weekNumber++;
            }
            return weeks;
        };

        // --- OPTIMIZED COMPONENTS ---
        const StatCard = ({ label, value, colorClass, icon: IconComp }) => (
            <div className={`glass-card p-4 rounded-2xl flex items-center justify-between relative overflow-hidden group`}>
                <div className={`absolute right-0 top-0 w-16 h-16 bg-gradient-to-br ${colorClass} opacity-10 rounded-bl-full group-hover:scale-110 transition-transform`}></div>
                <div>
                    <p className="text-xs font-bold text-slate-500 mb-1 tracking-wider uppercase">{label}</p>
                    <p className={`text-2xl font-display font-bold bg-clip-text text-transparent bg-gradient-to-r ${colorClass}`}>{value}</p>
                </div>
                <div className={`p-2.5 rounded-xl bg-gradient-to-br ${colorClass} text-white shadow-lg shadow-indigo-100`}>
                    <IconComp size={20} />
                </div>
            </div>
        );

        const WeekSelector = ({ currentDate, changeMonth, weeks, selectedWeek, setSelectedWeek }) => (
            <div className="w-full">
                <div className="flex justify-between items-center mb-4 px-2">
                    <button onClick={() => changeMonth(-1)} className="p-3 hover:bg-white rounded-2xl transition-all text-slate-500 hover:text-indigo-600 hover:shadow-md active:scale-95"><ChevronLeft size={22}/></button>
                    <h3 className="font-display font-bold text-slate-800 text-lg">{formatDateToKhmer(currentDate)}</h3>
                    <button onClick={() => changeMonth(1)} className="p-3 hover:bg-white rounded-2xl transition-all text-slate-500 hover:text-indigo-600 hover:shadow-md active:scale-95"><ChevronRight size={22}/></button>
                </div>
                <div className="flex flex-col gap-2 max-h-[300px] overflow-y-auto pr-1">
                    {weeks.map(week => (
                        <button
                            key={week.id}
                            onClick={() => setSelectedWeek(week.id)}
                            className={`w-full py-3 px-4 rounded-xl text-sm flex justify-between items-center transition-all duration-300 ${
                                selectedWeek === week.id
                                ? 'bg-gradient-to-r from-indigo-600 to-violet-600 text-white shadow-lg shadow-indigo-200 scale-[1.02]'
                                : 'bg-white/50 hover:bg-white text-slate-600 border border-slate-100 hover:border-indigo-100 hover:shadow-md'
                            }`}
                        >
                            <span className="font-bold">{week.label}</span>
                            <span className={`text-[10px] font-medium ${selectedWeek === week.id ? 'text-indigo-100' : 'text-slate-400'}`}>{week.range}</span>
                        </button>
                    ))}
                </div>
            </div>
        );

        // Memoized Student Card for Performance
        const StudentCard = React.memo(({ student, status, reason, monthlyStatus, onToggle, onReasonChange }) => {
            return (
                <div className="glass-card p-4 rounded-2xl animate-fade-in flex flex-col gap-3 group border-l-4 border-transparent hover:border-indigo-400">
                    <div className="flex justify-between items-start">
                        <div className="flex items-center gap-3">
                            <div className={`w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold shadow-sm transition-all duration-300 ${
                                status === 'present' ? 'bg-gradient-to-br from-emerald-400 to-emerald-600 text-white shadow-emerald-200' : 
                                status === 'absent' ? 'bg-gradient-to-br from-rose-400 to-rose-600 text-white shadow-rose-200' :
                                status === 'permission' ? 'bg-gradient-to-br from-amber-400 to-amber-500 text-white shadow-amber-200' :
                                'bg-slate-100 text-slate-500'
                            }`}>
                                {student.id}
                            </div>
                            <div>
                                <h3 className="font-display font-bold text-slate-800 text-sm group-hover:text-indigo-600 transition-colors">{student.name}</h3>
                                {monthlyStatus && (
                                    <span className={`inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-bold mt-1 ${
                                        monthlyStatus.type === 'good' 
                                        ? 'bg-emerald-100 text-emerald-700 border border-emerald-200' 
                                        : 'bg-rose-100 text-rose-700 border border-rose-200'
                                    }`}>
                                        {monthlyStatus.label}
                                    </span>
                                )}
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-3 gap-2">
                        <button 
                            onClick={() => onToggle(student, 'present')} 
                            onDoubleClick={() => onToggle(student, 'none')}
                            className={`py-3 rounded-xl flex justify-center items-center transition-all duration-200 active:scale-95 ${
                                status === 'present' 
                                ? 'bg-gradient-to-r from-emerald-500 to-emerald-600 text-white shadow-md shadow-emerald-200' 
                                : 'bg-slate-100 text-slate-400 hover:bg-emerald-50 hover:text-emerald-500'
                            }`}
                        >
                            <UserCheck size={20}/>
                        </button>
                        <button 
                            onClick={() => onToggle(student, 'permission')} 
                            onDoubleClick={() => onToggle(student, 'none')}
                            className={`py-3 rounded-xl flex justify-center items-center transition-all duration-200 active:scale-95 ${
                                status === 'permission' 
                                ? 'bg-gradient-to-r from-amber-400 to-amber-500 text-white shadow-md shadow-amber-200' 
                                : 'bg-slate-100 text-slate-400 hover:bg-amber-50 hover:text-amber-500'
                            }`}
                        >
                            <Clock size={20}/>
                        </button>
                        <button 
                            onClick={() => onToggle(student, 'absent')} 
                            onDoubleClick={() => onToggle(student, 'none')}
                            className={`py-3 rounded-xl flex justify-center items-center transition-all duration-200 active:scale-95 ${
                                status === 'absent' 
                                ? 'bg-gradient-to-r from-rose-500 to-rose-600 text-white shadow-md shadow-rose-200' 
                                : 'bg-slate-100 text-slate-400 hover:bg-rose-50 hover:text-rose-500'
                            }`}
                        >
                            <UserX size={20}/>
                        </button>
                    </div>

                    <input 
                        type="text" 
                        placeholder="·ûï·üí·ûü·üÅ·ûÑ·üó..." 
                        value={reason} 
                        onChange={(e) => onReasonChange(student, e.target.value)} 
                        className="w-full text-xs px-3 py-2.5 rounded-xl bg-slate-50 border border-transparent focus:bg-white focus:border-indigo-200 focus:ring-2 focus:ring-indigo-100 outline-none transition-all placeholder-slate-400 text-slate-600" 
                    />
                </div>
            );
        });

        // --- MAIN APP ---
        const StudentAttendanceApp = () => {
            const initialStudents = useMemo(() => [
                "·ûé·û∂·ûò ·ûü·üí·ûö·û∏·ûõ·û∂·ûÄ·üã", "·ûé·û∂·ûõ·üã ·ûõ·û∏·ûä·û∂", "·ûé·ûº ·ûú·üâ·û∂·ûì·üã·ûé·û∂", "·ûé·ûº ·ûú·üâ·û∂·ûì·üã·ûé·üÉ", "·ûè·ûÖ ·ûÄ·û∂·ûô·ûº",
                "·ûè·û∏ ·ûÖ·û∂·ûì·üã·ûé·ûª·ûÖ", "·ûè·û∏ ·ûÖ·û∂·ûì·üã·ûó·û∏·ûì", "·ûè·ûπ·ûÄ ·ûÖ·ûÑ·üí·ûö·û∑·ûè", "·ûè·û∫·ûò ·ûÖ·ûö·û∑·ûô·û∂", "·ûè·üÇ·ûò ·ûÖ·û∂·ûì·üã·ûö·û∏·ûê·ûÑ",
                "·ûü·üÄ·ûì ·ûÖ·û∂·ûì·üã·ûè·üÉ", "·ûê·ûì ·ûÖ·û∂·ûì·üã·ûê·û∂", "·ûê·ûì ·ûÖ·üÜ·ûö·ûæ·ûì", "·ûê·ûì ·û°·û∏·û¢·ûª·û∏", "·ûê·û∂·ûì ·ûü·üí·ûö·û∏·ûé·üÅ",
                "·ûê·üÅ·ûì ·ûü·üÅ·ûÑ·û†·üÅ·ûÑ", "·ûë·ûè ·ûå·û∏·ûé·û∂", "·ûë·û∏·ûÑ ·ûü·üí·ûè·üÇ·ûÑ", "·ûë·ûπ·ûò ·ûö·ûè·ûì·û∂", "·ûë·ûΩ·ûì ·ûü·ûª·ûó·û∏·ûì",
                "·ûë·ûΩ·ûì ·ûõ·û∏·ûè·û∂·ûÄ·üã", "·ûí·û∏ ·ûá·û∑·ûì·ûé·û∂", "·ûí·û∏·ûì ·ûí·üÄ·ûî", "·ûí·ûª·ûô ·ûü·üÜ·ûé·û∂·ûÑ", "·ûì·û∑·ûè ·ûü·ûª·û∏·ûé·û∂",
                "·ûì·ûø·ûì ·ûö·ûè·ûì·û∂", "·ûî·üâ·ûÄ·üã ·ûÖ·û∂·ûì·üã", "·ûî·üä·ûì ·ûú·ûª·ûè·ûí·û∏·ûò", "·ûî·üâ·û∂·ûì ·ûü·û∂·ûì·üã·ûä·û∂·ûì·üã", "·ûî·üä·ûª·ûì ·ûü·ûª·û∏·ûé·û∂·ûî·üä·ûª·ûì",
                "·ûè·üÉ ·ûú·û∑·ûü·üÉ·ûî·üä·ûª·ûì", "·ûí·ûø·ûì ·ûú·ûé·üí·ûé·ûí·û∏·ûò", "·ûï·ûõ·üí·ûõ·û∂ ·ûï·ûõ·üí·ûõ·û∏", "·ûï·û∂·ûì·üã ·ûï·û∂·ûì·üã·ûü·ûò·ûª·ûë·üí·ûö", "·ûï·üÖ ·ûÖ·û∂·ûì·üã·ûö·üâ·û∂",
                "·ûñ·ûª·ûí ·ûÜ·üÉ·ûô·üâ·û∂", "·ûñ·üí·ûö·ûø·ûì ·ûÅ·ûΩ·ûÖ", "·ûó·û∂·ûÇ ·ûï·û∂·ûì·üã·ûé·û∂", "·ûó·û∂·ûü·üã ·ûü·ûª·ûó·û∂·ûñ", "·ûó·ûø·ûì ·ûÄ·üÅ·ûü·û∏"
            ].map((name, index) => ({ id: index + 1, name })), []);

            const [currentDate, setCurrentDate] = useState(new Date());
            const [selectedWeek, setSelectedWeek] = useState(1);
            
            const [attendanceData, setAttendanceData] = useState({});
            const [attendanceReasons, setAttendanceReasons] = useState({});

            const [searchTerm, setSearchTerm] = useState('');
            const [notification, setNotification] = useState(null);
            const [filterStatus, setFilterStatus] = useState('all');
            
            const [activeTab, setActiveTab] = useState('list');
            
            const [isPdfGenerating, setIsPdfGenerating] = useState(false);
            const [isPdfLibraryReady, setIsPdfLibraryReady] = useState(false);
            const [isExcelLibraryReady, setIsExcelLibraryReady] = useState(false);
            const [pdfReportType, setPdfReportType] = useState('weekly');

            // Config for PDF
            const ITEMS_PER_PAGE_FIRST = 25; 
            const ITEMS_PER_PAGE_OTHERS = 32; 

            // Realtime Sync
            useEffect(() => {
                if (!window.db || !window.rdbOnValue) return;
                const dbRef = window.rdbRef(window.db, 'school_cleaning/roster_data');
                
                const unsubscribe = window.rdbOnValue(dbRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        setAttendanceData(data.attendance || {});
                        setAttendanceReasons(data.reasons || {});
                    } else {
                        setAttendanceData({});
                        setAttendanceReasons({});
                    }
                }, (error) => {
                    console.error("Firebase Sync Error:", error);
                    showNotification("·ûî·ûâ·üí·û†·û∂·ûî·ûé·üí·ûä·û∂·ûâ (Network Error)", "error");
                });
                return () => unsubscribe(); 
            }, []);

            // Check Libraries
            useEffect(() => {
                if (window.html2pdf) setIsPdfLibraryReady(true);
                if (window.ExcelJS) setIsExcelLibraryReady(true);
            }, []);

            // Helpers for DB Update
            const updateWeekAttendance = async (key, weekData) => {
                if (!window.db) { showNotification("Offline Mode", "error"); return; }
                try {
                    // Update only the specific week path
                    const updates = {};
                    updates['attendance/' + key] = weekData; 
                    await window.rdbUpdate(window.rdbRef(window.db, 'school_cleaning/roster_data'), updates);
                } catch (e) {
                    console.error("Save Error:", e);
                    showNotification("·ûî·ûö·û∂·ûá·üê·ûô·ûÄ·üí·ûì·ûª·ûÑ·ûÄ·û∂·ûö·ûö·ûÄ·üí·ûü·û∂·ûë·ûª·ûÄ", "error");
                }
            };

            const saveReasons = async (newReasons) => {
                if (!window.db) return;
                try {
                    await window.rdbUpdate(window.rdbRef(window.db, 'school_cleaning/roster_data'), { reasons: newReasons });
                } catch (e) { console.error(e); }
            };

            const changeMonth = (offset) => {
                const newDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + offset, 1);
                setCurrentDate(newDate);
                setSelectedWeek(1);
            };

            const currentKey = `${currentDate.getFullYear()}-${currentDate.getMonth() + 1}-W${selectedWeek}`;
            const weeks = useMemo(() => getWeeksOfMonth(currentDate), [currentDate]);
            const activeWeekInfo = weeks.find(w => w.id === selectedWeek) || weeks[0];

            // Optimized Handlers
            const toggleStatus = useCallback((student, status) => {
                const studentName = student.name;
                setAttendanceData(prev => {
                    const currentWeekData = { ...(prev[currentKey] || {}) };
                    if (status === 'none') {
                        currentWeekData[studentName] = null;
                    } else {
                        currentWeekData[studentName] = status;
                    }
                    const newData = { ...prev, [currentKey]: currentWeekData };
                    updateWeekAttendance(currentKey, currentWeekData);
                    return newData;
                });
            }, [currentKey]);

            const handleReasonChange = useCallback((student, value) => {
                const studentName = student.name;
                setAttendanceReasons(prev => {
                    const newData = {
                        ...prev,
                        [currentKey]: {
                            ...(prev[currentKey] || {}),
                            [studentName]: value
                        }
                    };
                    saveReasons(newData);
                    return newData;
                });
            }, [currentKey]);

            const getStatus = (student, key = currentKey) => attendanceData[key]?.[student.name] || 'none';
            const getReason = (student, key = currentKey) => attendanceReasons[key]?.[student.name] || '';

            const getMonthlyStatus = (student) => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth() + 1;
                let presentCount = 0;
                let absentOrPermissionCount = 0;

                weeks.forEach(week => {
                    const key = `${year}-${month}-W${week.id}`;
                    const status = attendanceData[key]?.[student.name]; 
                    if (status === 'present') presentCount++;
                    if (status === 'absent' || status === 'permission') absentOrPermissionCount++;
                });

                if (presentCount >= 3) return { type: 'good', label: '·ûõ·üí·û¢', color: 'text-emerald-700' };
                if (absentOrPermissionCount >= 2) return { type: 'bad', label: '·ûÅ·üí·ûü·üÑ·ûô', color: 'text-rose-700' };
                return null;
            };

            const stats = useMemo(() => {
                const currentData = attendanceData[currentKey] || {};
                const values = Object.values(currentData);
                return {
                    present: values.filter(v => v === 'present').length,
                    permission: values.filter(v => v === 'permission').length,
                    absent: values.filter(v => v === 'absent').length,
                    total: initialStudents.length
                };
            }, [attendanceData, currentKey, initialStudents.length]);

            // Logic for Toggle All (Mark All / Delete All)
            const toggleAllAttendance = () => {
                const isAllPresent = stats.present === stats.total;

                if (isAllPresent) {
                    // Action: Delete All
                    if (window.confirm("·ûè·ûæ·û¢·üí·ûì·ûÄ·ûñ·û∑·ûè·ûá·û∂·ûÖ·ûÑ·üã·ûõ·ûª·ûî·ûú·ûè·üí·ûè·ûò·û∂·ûì·ûë·û∂·üÜ·ûÑ·û¢·ûü·üã·ûü·ûò·üí·ûö·û∂·ûî·üã·ûü·ûî·üí·ûä·û∂·û†·üç·ûì·üÅ·üá·ûò·üÇ·ûì·ûë·üÅ?")) {
                        // Local update: remove key or set to empty/null
                        setAttendanceData(prev => {
                            const newData = { ...prev };
                            delete newData[currentKey]; // Remove from local state
                            
                            // Firebase update: Explicitly set week key to null to delete node
                            updateWeekAttendance(currentKey, null);
                            
                            return newData;
                        });
                        showNotification("·ûî·û∂·ûì·ûõ·ûª·ûî·ûú·ûè·üí·ûè·ûò·û∂·ûì·ûë·û∂·üÜ·ûÑ·û¢·ûü·üã!", 'success');
                    }
                } else {
                    // Action: Mark All Present
                    if (window.confirm("·ûè·ûæ·û¢·üí·ûì·ûÄ·ûñ·û∑·ûè·ûá·û∂·ûÖ·ûÑ·üã·ûÄ·ûè·üã·ûè·üí·ûö·û∂·ûú·ûè·üí·ûè·ûò·û∂·ûì·ûë·û∂·üÜ·ûÑ·û¢·ûü·üã·ûò·üÇ·ûì·ûë·üÅ?")) {
                        const newWeekData = {};
                        initialStudents.forEach(s => newWeekData[s.name] = 'present');
                        
                        setAttendanceData(prev => {
                            const newData = { ...prev, [currentKey]: newWeekData };
                            updateWeekAttendance(currentKey, newWeekData);
                            return newData;
                        });
                        showNotification("·ûî·û∂·ûì·ûÄ·ûè·üã·ûè·üí·ûö·û∂·ûú·ûè·üí·ûè·ûò·û∂·ûì·ûë·û∂·üÜ·ûÑ·û¢·ûü·üã!", 'success');
                    }
                }
            };

            const resetCurrentWeek = () => {
                if (window.confirm(`·ûõ·ûª·ûî·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô ${activeWeekInfo.label}?`)) {
                    setAttendanceData(prev => {
                        const newData = { ...prev };
                        delete newData[currentKey];
                        // Firebase delete
                        updateWeekAttendance(currentKey, null);
                        return newData;
                    });
                    setAttendanceReasons(prev => {
                        const newData = { ...prev };
                        delete newData[currentKey];
                        saveReasons(newData);
                        return newData;
                    });
                    showNotification("·ûî·û∂·ûì·ûõ·ûª·ûî!", 'error');
                }
            };

            // Excel & PDF Logic (Kept mostly same but optimized calls)
            const handleDownloadExcel = async (type = 'monthly') => {
                if (!isExcelLibraryReady) return showNotification("·ûÄ·üÜ·ûñ·ûª·ûÑ·ûä·üÜ·ûé·ûæ·ûö·ûÄ·û∂·ûö...", "error");
                showNotification(`·ûÄ·üÜ·ûñ·ûª·ûÑ·ûî·ûÑ·üí·ûÄ·ûæ·ûè Excel...`, "success");
                try {
                    const workbook = new window.ExcelJS.Workbook();
                    const sheetName = 'Monthly';
                    const worksheet = workbook.addWorksheet(sheetName);
                    // ... (Keeping Excel generation logic concise for brevity, assumes same logic as before)
                    // Simplified setup for demo, using same logic structure
                    const titleFont = { name: 'Khmer OS Muol Light', bold: true, size: 14 }; 
                    const headerFont = { name: 'Khmer OS Battambang', bold: true, size: 11 };
                    const dataFont = { name: 'Khmer OS Battambang', size: 11 };
                    const centerAlign = { vertical: 'middle', horizontal: 'center' };
                    
                    let columns = [{ key: 'id', width: 8 }, { key: 'name', width: 25 }];
                    let headerRowValues = ['·ûõ.·ûö', '·ûà·üí·ûò·üÑ·üá·ûì·û∑·ûü·üí·ûü·û∑·ûè'];

                    // ALWAYS MONTHLY LOGIC
                    weeks.forEach(w => { columns.push({ key: `w${w.id}`, width: 12 }); headerRowValues.push(w.label.replace("·ûü·ûî·üí·ûä·û∂·û†·üç·ûë·û∏", "·ûü")); });
                    columns.push({ key: 'total_p', width: 10 }, { key: 'total_per', width: 10 }, { key: 'total_a', width: 10 }, { key: 'result', width: 15 });
                    headerRowValues.push('·ûú·ûè·üí·ûè·ûò·û∂·ûì', '·ûÖ·üí·ûî·û∂·ûî·üã', '·û¢·ûú·ûè·üí·ûè·ûò·û∂·ûì', '·ûõ·ûë·üí·ûí·ûï·ûõ');
                    
                    worksheet.columns = columns;
                    worksheet.mergeCells(1, 1, 1, columns.length);
                    const titleRow = worksheet.getRow(1);
                    titleRow.getCell(1).value = `·ûö·ûî·û∂·ûô·ûÄ·û∂·ûö·ûé·üç·ûî·üí·ûö·ûÖ·û∂·üÜ·ûÅ·üÇ ${formatDateToKhmer(currentDate)}`;
                    titleRow.getCell(1).font = titleFont;
                    titleRow.getCell(1).alignment = centerAlign;
                    
                    const hRow = worksheet.getRow(2);
                    hRow.values = headerRowValues;
                    hRow.eachCell(c => { c.font = headerFont; c.alignment = centerAlign; c.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} }; });

                    let gp=0, gper=0, ga=0;
                    initialStudents.forEach((s, i) => {
                        const rowData = { id: i+1, name: s.name };
                        
                        let p=0, per=0, a=0;
                        weeks.forEach(w => {
                            const st = attendanceData[`${currentDate.getFullYear()}-${currentDate.getMonth()+1}-W${w.id}`]?.[s.name];
                            rowData[`w${w.id}`] = st==='present'?'·ûú':st==='permission'?'·ûÖ':st==='absent'?'·û¢':'-';
                            if(st==='present') p++; else if(st==='permission') per++; else if(st==='absent') a++;
                        });
                        rowData.total_p=p; rowData.total_per=per; rowData.total_a=a; rowData.result = p>=3?'·ûõ·üí·û¢':(per+a>=2?'·ûÅ·üí·ûü·üÑ·ûô':'');
                        gp+=p; gper+=per; ga+=a;
                        
                        const r = worksheet.addRow(rowData);
                        r.eachCell(c => { c.font = dataFont; c.alignment = centerAlign; c.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} }; });
                    });
                    
                    const buffer = await workbook.xlsx.writeBuffer();
                    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `Report_Monthly_${new Date().toISOString().slice(0,10)}.xlsx`;
                    link.click();
                    showNotification("·ûë·û∂·ûâ·ûô·ûÄ·ûö·ûΩ·ûÖ·ûö·û∂·ûõ·üã!", "success");
                } catch (err) { console.error(err); showNotification("·ûî·ûö·û∂·ûá·üê·ûô", "error"); }
            };

            const handleDownloadPDFFile = (type = 'monthly') => {
                if (!isPdfLibraryReady) return showNotification("·ûÄ·üÜ·ûñ·ûª·ûÑ·ûä·üÜ·ûé·ûæ·ûö·ûÄ·û∂·ûö...", "error");
                setPdfReportType('monthly'); // Force Monthly
                setIsPdfGenerating(true);
                showNotification(`·ûÄ·üÜ·ûñ·ûª·ûÑ·ûî·ûÑ·üí·ûÄ·ûæ·ûè PDF...`, "success");
                setTimeout(() => {
                    const element = document.getElementById('pdf-report-content');
                    const opt = { margin: 0, filename: `Report_Monthly.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
                    window.html2pdf().set(opt).from(element).save().then(() => setIsPdfGenerating(false)).catch(() => setIsPdfGenerating(false));
                }, 1000);
            };

            const copyToClipboard = () => {
                const text = `üìä ·ûö·ûî·û∂·ûô·ûÄ·û∂·ûö·ûé·üç ${activeWeekInfo.label}\n‚úÖ ·ûú·ûè·üí·ûè·ûò·û∂·ûì: ${stats.present}\nüìù ·ûÖ·üí·ûî·û∂·ûî·üã: ${stats.permission}\n‚ùå ·û¢·ûú·ûè·üí·ûè·ûò·û∂·ûì: ${stats.absent}`;
                const ta = document.createElement("textarea");
                ta.value = text;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                showNotification("·ûî·û∂·ûì·ûÖ·ûò·üí·ûõ·ûÑ!", "success");
            };

            const showNotification = (msg, type) => {
                setNotification({ msg, type });
                setTimeout(() => setNotification(null), 3000);
            };

            const filteredStudents = useMemo(() => initialStudents.filter(s => {
                const matchesSearch = s.name.toLowerCase().includes(searchTerm.toLowerCase());
                const status = getStatus(s);
                const matchesFilter = filterStatus === 'all' || (filterStatus === 'none' && status === 'none') || status === filterStatus;
                return matchesSearch && matchesFilter;
            }), [initialStudents, searchTerm, filterStatus, attendanceData, currentKey]);

            // PDF Pagination
            const pdfPages = useMemo(() => {
                const pages = [];
                const page1Data = filteredStudents.slice(0, ITEMS_PER_PAGE_FIRST);
                if (page1Data.length > 0) pages.push({ type: 'first', items: page1Data, startIndex: 1 });
                let currentIdx = ITEMS_PER_PAGE_FIRST;
                while (currentIdx < filteredStudents.length) {
                    const chunk = filteredStudents.slice(currentIdx, currentIdx + ITEMS_PER_PAGE_OTHERS);
                    pages.push({ type: 'standard', items: chunk, startIndex: currentIdx + 1 });
                    currentIdx += ITEMS_PER_PAGE_OTHERS;
                }
                if (pages.length > 0 && pages[pages.length - 1].items.length > 27) pages.push({ type: 'signature_only', items: [] });
                return pages;
            }, [filteredStudents]);

            // --- RENDER ---
            return (
                <div className="font-body selection:bg-indigo-100 selection:text-indigo-700 pb-24 md:pb-0">
                    
                    {/* Header - Glassmorphism */}
                    <div className="glass-panel sticky top-0 z-30 border-b border-white/40 shadow-sm px-4 py-3 md:px-6 md:py-4">
                        <div className="max-w-7xl mx-auto flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div className="flex items-center gap-3">
                                <div className="p-2.5 bg-gradient-to-br from-indigo-600 to-violet-600 rounded-xl text-white shadow-lg shadow-indigo-200">
                                    <Sparkles size={24} />
                                </div>
                                <div>
                                    <h1 className="font-header text-lg md:text-xl text-slate-800 bg-clip-text text-transparent bg-gradient-to-r from-indigo-700 to-violet-700">·ûú·üÅ·ûì·ûü·ûò·üí·û¢·û∂·ûè·ûü·û∂·ûõ·û∂</h1>
                                    <p className="text-xs font-bold text-slate-500 tracking-wide">·ûá·üÜ·ûì·û∂·ûì·üã3 DPA2</p>
                                </div>
                            </div>

                            {/* Desktop Stats */}
                            <div className="hidden md:flex gap-4">
                                <div className="flex items-center gap-2 px-4 py-2 bg-white/60 rounded-xl border border-white/50">
                                    <div className="w-2 h-2 rounded-full bg-emerald-500"></div>
                                    <span className="text-sm font-bold text-slate-600">·ûú·ûè·üí·ûè·ûò·û∂·ûì: <span className="text-emerald-600 text-lg">{stats.present}</span></span>
                                </div>
                                <div className="flex items-center gap-2 px-4 py-2 bg-white/60 rounded-xl border border-white/50">
                                    <div className="w-2 h-2 rounded-full bg-rose-500"></div>
                                    <span className="text-sm font-bold text-slate-600">·û¢·ûú·ûè·üí·ûè·ûò·û∂·ûì: <span className="text-rose-600 text-lg">{stats.absent}</span></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto p-4 md:p-6 flex flex-col md:flex-row gap-6">
                        
                        {/* Sidebar (Desktop) */}
                        <div className="hidden md:block w-80 shrink-0 space-y-6">
                            <div className="glass-card p-5 rounded-3xl">
                                <h2 className="font-display font-bold text-slate-700 mb-4 flex items-center gap-2">
                                    <Calendar className="text-indigo-500" size={18} />
                                    ·ûÄ·û∂·ûõ·ûú·û∑·ûó·û∂·ûÇ
                                </h2>
                                <WeekSelector currentDate={currentDate} changeMonth={changeMonth} weeks={weeks} selectedWeek={selectedWeek} setSelectedWeek={setSelectedWeek} />
                            </div>

                            <div className="glass-card p-5 rounded-3xl">
                                <h2 className="font-display font-bold text-slate-700 mb-4">·ûü·üí·ûê·û∑·ûè·û∑·ûî·üí·ûö·ûÖ·û∂·üÜ·ûü·ûî·üí·ûä·û∂·û†·üç</h2>
                                <div className="grid grid-cols-2 gap-3">
                                    <StatCard label="·ûú·ûè·üí·ûè·ûò·û∂·ûì" value={stats.present} colorClass="from-emerald-500 to-teal-500" icon={UserCheck} />
                                    <StatCard label="·ûÖ·üí·ûî·û∂·ûî·üã" value={stats.permission} colorClass="from-amber-400 to-orange-500" icon={Clock} />
                                    <StatCard label="·û¢·ûú·ûè·üí·ûè·ûò·û∂·ûì" value={stats.absent} colorClass="from-rose-500 to-pink-500" icon={UserX} />
                                    <StatCard label="·ûü·ûö·ûª·ûî" value={stats.total} colorClass="from-slate-600 to-slate-800" icon={Users} />
                                </div>
                            </div>

                            <div className="glass-card p-5 rounded-3xl space-y-3">
                                <button onClick={() => handleDownloadPDFFile('monthly')} className="w-full py-3 rounded-xl bg-slate-800 text-white font-bold text-sm shadow-lg shadow-slate-200 hover:shadow-xl hover:-translate-y-0.5 transition-all flex items-center justify-center gap-2">
                                    <Download size={16}/> PDF ·ûî·üí·ûö·ûÖ·û∂·üÜ·ûÅ·üÇ
                                </button>
                                <button onClick={() => handleDownloadExcel('monthly')} className="w-full py-3 rounded-xl bg-emerald-600 text-white font-bold text-sm shadow-lg shadow-emerald-200 hover:shadow-xl hover:-translate-y-0.5 transition-all flex items-center justify-center gap-2">
                                    <FileSpreadsheet size={16}/> Excel ·ûî·üí·ûö·ûÖ·û∂·üÜ·ûÅ·üÇ
                                </button>
                                <button onClick={copyToClipboard} className="w-full py-3 rounded-xl bg-white border border-slate-200 text-slate-600 font-bold text-sm hover:bg-slate-50 transition-all flex items-center justify-center gap-2">
                                    <Copy size={16}/> ·ûÖ·ûò·üí·ûõ·ûÑ
                                </button>
                            </div>
                        </div>

                        {/* Main Content Area */}
                        <div className="flex-1 space-y-6">
                            
                            {/* Toolbar (Unified Mobile Search Bar) */}
                            <div className="sticky top-[80px] md:top-24 z-20">
                                <div className="relative group shadow-sm rounded-2xl">
                                    {/* Left Icon */}
                                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <Search className="text-slate-400 group-focus-within:text-indigo-500 transition-colors" size={20} />
                                    </div>

                                    {/* Input */}
                                    <input
                                        type="text"
                                        placeholder="·ûü·üí·ûú·üÇ·ûÑ·ûö·ûÄ..."
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                        className="w-full pl-10 pr-24 py-3.5 bg-white/90 backdrop-blur-md border border-white/60 rounded-2xl focus:ring-2 focus:ring-indigo-200 focus:border-indigo-300 outline-none transition-all text-sm font-medium"
                                    />

                                    {/* Right Actions */}
                                    <div className="absolute inset-y-0 right-0 flex items-center pr-2 gap-1">
                                        {/* Divider */}
                                        <div className="h-6 w-px bg-slate-200 mx-1"></div>

                                        {/* Filter Dropdown */}
                                        <div className="relative">
                                            <select
                                                value={filterStatus}
                                                onChange={(e) => setFilterStatus(e.target.value)}
                                                className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                                            >
                                                <option value="all">·ûë·û∂·üÜ·ûÑ·û¢·ûü·üã</option>
                                                <option value="present">·ûú·ûè·üí·ûè·ûò·û∂·ûì</option>
                                                <option value="permission">·ûÖ·üí·ûî·û∂·ûî·üã</option>
                                                <option value="absent">·û¢·ûú·ûè·üí·ûè·ûò·û∂·ûì</option>
                                            </select>
                                            <div className={`p-2 rounded-xl transition-colors ${filterStatus !== 'all' ? 'bg-indigo-50 text-indigo-600' : 'text-slate-400 hover:text-indigo-500'}`}>
                                                {filterStatus === 'all' && <Filter size={20} />}
                                                {filterStatus === 'present' && <UserCheck size={20} className="text-emerald-500" />}
                                                {filterStatus === 'permission' && <Clock size={20} className="text-amber-500" />}
                                                {filterStatus === 'absent' && <UserX size={20} className="text-rose-500" />}
                                            </div>
                                        </div>

                                        {/* Mark All / Reset Toggle Button */}
                                        <button
                                            onClick={toggleAllAttendance}
                                            className={`p-2 rounded-xl transition-all ${stats.present === stats.total ? 'bg-rose-50 text-rose-500 hover:bg-rose-100' : 'text-slate-400 hover:text-indigo-600 hover:bg-indigo-50'}`}
                                            title={stats.present === stats.total ? "Clear All Attendance" : "Mark All Present"}
                                        >
                                            {stats.present === stats.total ? <Trash2 size={20} /> : <CheckCircle2 size={20} />}
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {/* Mobile View: Week Selector & Stats (Only if tab is not 'list') */}
                            <div className="md:hidden">
                                {activeTab === 'calendar' && (
                                    <div className="space-y-4 animate-fade-in">
                                        <div className="glass-card p-4 rounded-2xl">
                                            <WeekSelector currentDate={currentDate} changeMonth={changeMonth} weeks={weeks} selectedWeek={selectedWeek} setSelectedWeek={setSelectedWeek} />
                                        </div>
                                    </div>
                                )}
                                {activeTab === 'report' && (
                                    <div className="space-y-4 animate-fade-in">
                                        <div className="glass-card p-4 rounded-2xl">
                                            <h2 className="font-display font-bold text-slate-700 mb-4">·ûü·üí·ûê·û∑·ûè·û∑·ûü·ûö·ûª·ûî</h2>
                                            <div className="grid grid-cols-2 gap-3">
                                                <StatCard label="·ûú·ûè·üí·ûè·ûò·û∂·ûì" value={stats.present} colorClass="from-emerald-500 to-teal-500" icon={UserCheck} />
                                                <StatCard label="·ûÖ·üí·ûî·û∂·ûî·üã" value={stats.permission} colorClass="from-amber-400 to-orange-500" icon={Clock} />
                                                <StatCard label="·û¢·ûú·ûè·üí·ûè·ûò·û∂·ûì" value={stats.absent} colorClass="from-rose-500 to-pink-500" icon={UserX} />
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-4 gap-3">
                                            <button onClick={() => handleDownloadPDFFile('monthly')} className="aspect-square flex items-center justify-center bg-slate-800 text-white rounded-2xl shadow-md active:scale-95 transition-all" title="PDF ·ûî·üí·ûö·ûÖ·û∂·üÜ·ûÅ·üÇ">
                                                <Download size={22}/>
                                            </button>
                                            <button onClick={() => handleDownloadExcel('monthly')} className="aspect-square flex items-center justify-center bg-emerald-600 text-white rounded-2xl shadow-md active:scale-95 transition-all" title="Excel ·ûî·üí·ûö·ûÖ·û∂·üÜ·ûÅ·üÇ">
                                                <FileSpreadsheet size={22}/>
                                            </button>
                                            <button onClick={copyToClipboard} className="aspect-square flex items-center justify-center bg-white border border-slate-200 text-slate-600 rounded-2xl shadow-sm active:scale-95 transition-all">
                                                <Copy size={22}/>
                                            </button>
                                            <button onClick={resetCurrentWeek} className="aspect-square flex items-center justify-center bg-rose-50 text-rose-600 border border-rose-200 rounded-2xl active:scale-95 transition-all">
                                                <Trash2 size={22}/>
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Student List */}
                            {(activeTab === 'list' || window.innerWidth >= 768) && (
                                <div className="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4 pb-20">
                                    {filteredStudents.map((student) => (
                                        <StudentCard 
                                            key={student.id} 
                                            student={student} 
                                            status={getStatus(student)} 
                                            reason={getReason(student)}
                                            monthlyStatus={getMonthlyStatus(student)}
                                            onToggle={toggleStatus}
                                            onReasonChange={handleReasonChange}
                                        />
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Mobile Bottom Navigation - Improved Icon-Only Floating Dock */}
                    <div className="md:hidden fixed bottom-6 left-1/2 transform -translate-x-1/2 z-50 w-auto">
                        <div className="glass-panel px-6 py-3 rounded-full shadow-2xl flex items-center gap-6 border border-white/60 bg-white/80 backdrop-blur-xl">
                            <button 
                                onClick={() => setActiveTab('list')} 
                                className={`p-3 rounded-full transition-all duration-300 relative group ${activeTab === 'list' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-300 scale-110' : 'text-slate-400 hover:bg-slate-100'}`}
                            >
                                <Users size={24} strokeWidth={activeTab === 'list' ? 2.5 : 2} />
                                {activeTab === 'list' && <span className="absolute -top-1 right-0 w-2 h-2 bg-rose-500 rounded-full animate-pulse"></span>}
                            </button>
                            
                            <button 
                                onClick={() => setActiveTab('calendar')} 
                                className={`p-3 rounded-full transition-all duration-300 ${activeTab === 'calendar' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-300 scale-110' : 'text-slate-400 hover:bg-slate-100'}`}
                            >
                                <LayoutDashboard size={24} strokeWidth={activeTab === 'calendar' ? 2.5 : 2} />
                            </button>
                            
                            <button 
                                onClick={() => setActiveTab('report')} 
                                className={`p-3 rounded-full transition-all duration-300 ${activeTab === 'report' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-300 scale-110' : 'text-slate-400 hover:bg-slate-100'}`}
                            >
                                <BarChart3 size={24} strokeWidth={activeTab === 'report' ? 2.5 : 2} />
                            </button>
                        </div>
                    </div>

                    {/* Toast Notification */}
                    {notification && (
                        <div className={`fixed top-6 left-1/2 transform -translate-x-1/2 z-[100] px-6 py-3 rounded-2xl shadow-2xl flex items-center gap-3 animate-fade-in glass-panel border ${
                            notification.type === 'error' ? 'border-rose-200 bg-rose-50/90 text-rose-700' : 'border-emerald-200 bg-emerald-50/90 text-emerald-800'
                        }`}>
                            {notification.type === 'success' ? <CheckCircle2 size={20} className="text-emerald-500" /> : <AlertCircle size={20} className="text-rose-500" />}
                            <span className="font-bold text-sm">{notification.msg}</span>
                        </div>
                    )}

                    {/* Hidden PDF Content */}
                    <div id="pdf-container-wrapper" className={`fixed inset-0 z-[9999] bg-slate-200 flex justify-center items-start overflow-auto p-0 ${isPdfGenerating ? 'block' : 'hidden'}`}>
                        <div id="pdf-report-content" className="w-full max-w-[210mm]">
                            {pdfPages.map((page, i) => (
                                <div key={i} className="bg-white w-[210mm] h-[296mm] p-[12mm] relative flex flex-col" style={{fontFamily: "'Noto Sans Khmer', sans-serif", pageBreakAfter: 'always'}}>
                                    <div className="text-center mb-6">
                                        <h3 className="font-header text-sm mb-1">·ûñ·üí·ûö·üá·ûö·û∂·ûá·û∂·ûé·û∂·ûÖ·ûÄ·üí·ûö·ûÄ·ûò·üí·ûñ·ûª·ûá·û∂</h3>
                                        <h3 className="font-header text-sm mb-2">·ûá·û∂·ûè·û∑ ·ûü·û∂·ûü·ûì·û∂ ·ûñ·üí·ûö·üá·ûò·û†·û∂·ûÄ·üí·ûü·ûè·üí·ûö</h3>
                                        <div className="text-2xl opacity-50 mb-2">‚ù¶</div>
                                        <h1 className="font-header text-lg text-indigo-900 font-bold">{pdfReportType === 'weekly' ? "·ûè·û∂·ûö·û∂·ûÑ·ûú·üÅ·ûì·ûü·ûò·üí·û¢·û∂·ûè" : "·ûö·ûî·û∂·ûô·ûÄ·û∂·ûö·ûé·üç·ûî·üí·ûö·ûÖ·û∂·üÜ·ûÅ·üÇ"}</h1>
                                        <p className="text-sm font-bold mt-1">{formatDateToKhmer(currentDate)} | {activeWeekInfo.label}</p>
                                    </div>
                                    {/* Table Content */}
                                    <table className="w-full border-collapse border border-gray-300 text-xs">
                                        <thead>
                                            <tr className="bg-indigo-900 text-white">
                                                <th className="border p-2 w-10">·ûõ.·ûö</th>
                                                <th className="border p-2 text-left">·ûà·üí·ûò·üÑ·üá</th>
                                                {/* Only Monthly columns logic here as per request to default download monthly */}
                                                {weeks.map(week => (
                                                    <th key={week.id} className="border p-2 w-10 text-center font-bold">
                                                        {week.label.replace("·ûü·ûî·üí·ûä·û∂·û†·üç·ûë·û∏", "·ûü")}
                                                    </th>
                                                ))}
                                                <th className="border p-2 w-24">·ûü·üí·ûê·û∂·ûì·ûó·û∂·ûñ</th>
                                                <th className="border p-2 w-32">·ûï·üí·ûü·üÅ·ûÑ·üó</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {page.items.map((s, idx) => {
                                                const monthlyStatus = getMonthlyStatus(s);
                                                return (
                                                    <tr key={s.id} className={idx%2===0?'bg-white':'bg-gray-50'}>
                                                        <td className="border p-2 text-center">{(page.startIndex||0)+idx}</td>
                                                        <td className="border p-2 font-bold">{s.name}</td>
                                                        {weeks.map(week => {
                                                            const wKey = `${currentDate.getFullYear()}-${currentDate.getMonth()+1}-W${week.id}`;
                                                            const wStatus = attendanceData[wKey]?.[s.name];
                                                            let symbol = "-";
                                                            let color = "text-gray-300";
                                                            if (wStatus === 'present') { symbol = "‚úì"; color = "text-green-600 font-bold"; }
                                                            else if (wStatus === 'permission') { symbol = "‚óè"; color = "text-orange-500 font-bold"; }
                                                            else if (wStatus === 'absent') { symbol = "‚úï"; color = "text-red-600 font-bold"; }
                                                            return <td key={week.id} className={`border border-gray-300 p-1.5 text-center ${color}`}>{symbol}</td>;
                                                        })}
                                                        <td className="border p-2 text-center">
                                                            {monthlyStatus ? <span className={`font-bold ${monthlyStatus.color}`}>{monthlyStatus.label}</span> : "-"}
                                                        </td>
                                                        <td className="border p-2">{getReason(s)}</td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                    {/* Signature */}
                                    {i===pdfPages.length-1 && (
                                        <div className="mt-auto pt-10 flex justify-end">
                                            <div className="text-center w-48">
                                                <p className="text-xs font-bold mb-2">·ûö·û∂·ûá·ûí·û∂·ûì·û∏·ûó·üí·ûì·üÜ·ûñ·üÅ·ûâ, {formatDateToKhmer(new Date(), true)}</p>
                                                <p className="font-header text-sm font-bold mb-16">·û¢·üí·ûì·ûÄ·ûÄ·ûè·üã·ûè·üí·ûö·û∂</p>
                                                <div className="border-t border-black w-32 mx-auto"></div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<StudentAttendanceApp />);
    </script>
</body>
</html>
