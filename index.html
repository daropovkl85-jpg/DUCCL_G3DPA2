<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>áœáŸá“áŸá˜áŸ’á¢á¶ááŸá¶á›á¶ á‡áŸ†á“á¶á“áŸ‹3 DPA2</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- HTML2PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- ExcelJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // á”áŸ’ášá¾á”áŸ’ášá¶áŸáŸ‹ Realtime Database
        import { getDatabase, ref, onValue, set, update } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // --- CUSTOM FIREBASE CONFIGURATION (duccleaner) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAJW7lYgDEr5eqAlJy26ZYoyJWZobJnsU0",
            authDomain: "duccleaner.firebaseapp.com",
            projectId: "duccleaner",
            // *** á…áŸ†áá»á…áŸáŸ†áá¶á“áŸ‹á”áŸ†á•á»ááŸ– áŸá¼á˜á–á·á“á·ááŸ’á™ URL á“áŸáŸ‡á€áŸ’á“á»á„ Firebase Console ášá”áŸáŸ‹á¢áŸ’á“á€ ***
            databaseURL: "https://duccleaner-default-rtdb.asia-southeast1.firebasedatabase.app/", 
            storageBucket: "duccleaner.firebasestorage.app",
            messagingSenderId: "166864480178",
            appId: "1:166864480178:web:9f8aedfdd0135f887fe6ab",
            measurementId: "G-K2TQHHPJ17"
        };

        // Initialize Firebase
        try {
            const app = initializeApp(firebaseConfig);
            const db = getDatabase(app);

            // Expose to window for the React component
            window.db = db;
            window.rdbRef = ref;
            window.rdbSet = set;
            window.rdbUpdate = update;
            window.rdbOnValue = onValue;
            console.log("Firebase initialized with URL:", firebaseConfig.databaseURL);
        } catch (err) {
            console.error("Firebase Init Error:", err);
            alert("á€áŸ†á á»áŸá€á¶ášá—áŸ’á‡á¶á”áŸ‹ Firebase: " + err.message);
        }
    </script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@300;400;500;600;700&family=Noto+Sans+Khmer:wght@300;400;500;600;700&family=Moul&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans Khmer', sans-serif; }
        .font-display { font-family: 'Kantumruy Pro', sans-serif; }
        .font-header { font-family: 'Moul', serif; }
        
        /* Hide scrollbar for cleaner UI */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Print styles correction */
        @media print {
            @page { size: A4; margin: 0; }
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print { display: none !important; }
        }
        
        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- INTERNAL ICONS ---
        const Icon = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );

        const Calendar = (props) => <Icon {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></Icon>;
        const UserCheck = (props) => <Icon {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><polyline points="16 11 18 13 22 9"/></Icon>;
        const UserX = (props) => <Icon {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="17" x2="22" y1="8" y2="13"/><line x1="22" x2="17" y1="8" y2="13"/></Icon>;
        const Clock = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></Icon>;
        const Copy = (props) => <Icon {...props}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></Icon>;
        const Search = (props) => <Icon {...props}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></Icon>;
        const Trash2 = (props) => <Icon {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></Icon>;
        const ChevronLeft = (props) => <Icon {...props}><path d="m15 18-6-6 6-6"/></Icon>;
        const ChevronRight = (props) => <Icon {...props}><path d="m9 18 6-6-6-6"/></Icon>;
        const Filter = (props) => <Icon {...props}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></Icon>;
        const CheckCircle2 = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></Icon>;
        const AlertCircle = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></Icon>;
        const Users = (props) => <Icon {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></Icon>;
        const BarChart3 = (props) => <Icon {...props}><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></Icon>;
        const LayoutDashboard = (props) => <Icon {...props}><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></Icon>;
        const Download = (props) => <Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></Icon>;
        const FileBarChart = (props) => <Icon {...props}><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M8 13h2"/><path d="M12 17v-4"/><path d="M16 17v-2"/></Icon>;
        const FileSpreadsheet = (props) => <Icon {...props}><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M8 13h2"/><path d="M14 13h2"/><path d="M8 17h2"/><path d="M14 17h2"/></Icon>;

        // --- GLOBAL HELPERS ---
        const formatDateToKhmer = (date, full = false) => {
            const months = [
                "á˜á€ášá¶", "á€á»á˜áŸ’á—áŸˆ", "á˜á¸á“á¶", "á˜áŸáŸá¶", "á§áŸá—á¶", "á˜á·áá»á“á¶",
                "á€á€áŸ’á€áŠá¶", "áŸá¸á á¶", "á€á‰áŸ’á‰á¶", "áá»á›á¶", "áœá·á…áŸ’á†á·á€á¶", "á’áŸ’á“á¼"
            ];
            const days = ["á¢á¶á‘á·ááŸ’á™", "á…á“áŸ’á‘", "á¢á„áŸ’á‚á¶áš", "á–á»á’", "á–áŸ’ášá áŸáŸ’á”áá·áŸ", "áŸá»á€áŸ’áš", "áŸáŸ…ášáŸ"];
            
            const dayName = days[date.getDay()];
            const day = date.getDate();
            const month = months[date.getMonth()];
            const year = date.getFullYear();

            const toKhmerNum = (num) => num.toString().replace(/\d/g, d => 'áŸ áŸ¡áŸ¢áŸ£áŸ¤áŸ¥áŸ¦áŸ§áŸ¨áŸ©'[d]);

            if (full) {
                return `ááŸ’á„áŸƒ${dayName} á‘á¸${toKhmerNum(day)} ááŸ‚${month} á†áŸ’á“á¶áŸ†${toKhmerNum(year)}`;
            }
            return `ááŸ‚${month} á†áŸ’á“á¶áŸ†${toKhmerNum(year)}`;
        };

        const getWeeksOfMonth = (date) => {
            const year = date.getFullYear();
            const month = date.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);

            const weeks = [];
            let currentWeekStart = firstDay;
            let weekNumber = 1;

            while (currentWeekStart <= lastDay) {
                let currentWeekEnd = new Date(currentWeekStart);
                const dayOfWeek = currentWeekStart.getDay();
                const daysUntilSunday = dayOfWeek === 0 ? 0 : 7 - dayOfWeek;
                currentWeekEnd.setDate(currentWeekStart.getDate() + daysUntilSunday);
                
                if (currentWeekEnd > lastDay) currentWeekEnd = lastDay;

                const startStr = `${currentWeekStart.getDate()}`;
                const endStr = `${currentWeekEnd.getDate()} ${formatDateToKhmer(currentWeekEnd).split(' ')[0]}`;

                weeks.push({
                    id: weekNumber,
                    label: `áŸá”áŸ’áŠá¶á áŸá‘á¸ ${weekNumber}`,
                    range: `${startStr} - ${endStr}`
                });

                currentWeekStart = new Date(currentWeekEnd);
                currentWeekStart.setDate(currentWeekStart.getDate() + 1);
                weekNumber++;
            }
            return weeks;
        };

        // --- COMPONENTS ---
        const StatCard = ({ label, value, color, bg }) => (
            <div className={`${bg} p-3 rounded-xl border border-white/50 shadow-sm`}>
                <p className={`text-xs font-bold ${color} opacity-80 mb-1`}>{label}</p>
                <p className={`text-2xl font-display font-bold ${color}`}>{value}</p>
            </div>
        );

        const WeekSelector = ({ currentDate, changeMonth, weeks, selectedWeek, setSelectedWeek }) => (
            <div className="bg-white/50 backdrop-blur rounded-xl p-2 w-full">
                <div className="flex justify-between items-center mb-4 px-2">
                    <button onClick={() => changeMonth(-1)} className="p-1.5 hover:bg-white rounded-lg transition-colors text-slate-600"><ChevronLeft size={20}/></button>
                    <h3 className="font-display font-bold text-slate-800">{formatDateToKhmer(currentDate)}</h3>
                    <button onClick={() => changeMonth(1)} className="p-1.5 hover:bg-white rounded-lg transition-colors text-slate-600"><ChevronRight size={20}/></button>
                </div>
                <div className="grid grid-cols-1 gap-2">
                    {weeks.map(week => (
                        <button
                            key={week.id}
                            onClick={() => setSelectedWeek(week.id)}
                            className={`w-full py-2.5 px-4 rounded-xl text-sm flex justify-between items-center transition-all ${
                                selectedWeek === week.id
                                ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200 scale-[1.02]'
                                : 'bg-white hover:bg-slate-50 text-slate-600 border border-slate-100 hover:border-slate-200'
                            }`}
                        >
                            <span className="font-bold">{week.label}</span>
                            <span className={`text-[10px] font-medium ${selectedWeek === week.id ? 'text-indigo-200' : 'text-slate-400'}`}>{week.range}</span>
                        </button>
                    ))}
                </div>
            </div>
        );

        // --- MAIN APP ---
        const StudentAttendanceApp = () => {
            // Data
            const initialStudents = useMemo(() => [
                "áá¶á˜ áŸáŸ’ášá¸á›á¶á€áŸ‹", "áá¶á›áŸ‹ á›á¸áŠá¶", "áá¼ áœáŸ‰á¶á“áŸ‹áá¶", "áá¼ áœáŸ‰á¶á“áŸ‹ááŸƒ", "áá… á€á¶á™á¼",
                "áá¸ á…á¶á“áŸ‹áá»á…", "áá¸ á…á¶á“áŸ‹á—á¸á“", "áá¹á€ á…á„áŸ’ášá·á", "ááºá˜ á…ášá·á™á¶", "ááŸ‚á˜ á…á¶á“áŸ‹ášá¸áá„",
                "áŸáŸ€á“ á…á¶á“áŸ‹ááŸƒ", "áá“ á…á¶á“áŸ‹áá¶", "áá“ á…áŸ†ášá¾á“", "áá“ á¡á¸á¢á»á¸", "áá¶á“ áŸáŸ’ášá¸ááŸ",
                "ááŸá“ áŸáŸá„á áŸá„", "á‘á áŒá¸áá¶", "á‘á¸á„ áŸáŸ’ááŸ‚á„", "á‘á¹á˜ ášáá“á¶", "á‘á½á“ áŸá»á—á¸á“",
                "á‘á½á“ á›á¸áá¶á€áŸ‹", "á’á¸ á‡á·á“áá¶", "á’á¸á“ á’áŸ€á”", "á’á»á™ áŸáŸ†áá¶á„", "á“á·á áŸá»á¸áá¶",
                "á“á¿á“ ášáá“á¶", "á”áŸ‰á€áŸ‹ á…á¶á“áŸ‹", "á”áŸŠá“ áœá»áá’á¸á˜", "á”áŸ‰á¶á“ áŸá¶á“áŸ‹áŠá¶á“áŸ‹", "á”áŸŠá»á“ áŸá»á¸áá¶á”áŸŠá»á“",
                "ááŸƒ áœá·áŸáŸƒá”áŸŠá»á“", "á’á¿á“ áœááŸ’áá’á¸á˜", "á•á›áŸ’á›á¶ á•á›áŸ’á›á¸", "á•á¶á“áŸ‹ á•á¶á“áŸ‹áŸá˜á»á‘áŸ’áš", "á•áŸ… á…á¶á“áŸ‹ášáŸ‰á¶",
                "á–á»á’ á†áŸƒá™áŸ‰á¶", "á–áŸ’ášá¿á“ áá½á…", "á—á¶á‚ á•á¶á“áŸ‹áá¶", "á—á¶áŸáŸ‹ áŸá»á—á¶á–", "á—á¿á“ á€áŸáŸá¸"
            ].map((name, index) => ({ id: index + 1, name })), []);

            const [currentDate, setCurrentDate] = useState(new Date());
            const [selectedWeek, setSelectedWeek] = useState(1);
            
            // Firebase State
            // No User State anymore
            const [attendanceData, setAttendanceData] = useState({});
            const [attendanceReasons, setAttendanceReasons] = useState({});

            const [searchTerm, setSearchTerm] = useState('');
            const [notification, setNotification] = useState(null);
            const [filterStatus, setFilterStatus] = useState('all');
            
            const [activeTab, setActiveTab] = useState('list');
            
            const [isPdfGenerating, setIsPdfGenerating] = useState(false);
            const [isPdfLibraryReady, setIsPdfLibraryReady] = useState(false);
            const [isExcelLibraryReady, setIsExcelLibraryReady] = useState(false);
            
            const [pdfReportType, setPdfReportType] = useState('weekly');

            // PDF Pagination Configuration
            const ITEMS_PER_PAGE_FIRST = 25; 
            const ITEMS_PER_PAGE_OTHERS = 32; 

            // Realtime Sync from Realtime Database (rdbOnValue)
            useEffect(() => {
                if (!window.db || !window.rdbOnValue) return;

                // Path: school_cleaning/roster_data
                const dbRef = window.rdbRef(window.db, 'school_cleaning/roster_data');
                
                const unsubscribe = window.rdbOnValue(dbRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        setAttendanceData(data.attendance || {});
                        setAttendanceReasons(data.reasons || {});
                    } else {
                        // Data doesn't exist yet, that's fine
                        setAttendanceData({});
                        setAttendanceReasons({});
                    }
                }, (error) => {
                    console.error("Firebase Sync Error:", error);
                    showNotification("á˜á¶á“á”á‰áŸ’á á¶á€áŸ’á“á»á„á€á¶ášá‘á¶á‰á™á€á‘á·á“áŸ’á“á“áŸá™ (áŸá¼á˜á–á·á“á·ááŸ’á™ URL á¬ Rules)", "error");
                });

                return () => unsubscribe(); 
            }, []);

            // Save Helpers
            const saveAttendance = async (newAttendance) => {
                if (!window.db) {
                    showNotification("á˜á·á“á˜á¶á“á€á¶ášá—áŸ’á‡á¶á”áŸ‹á‘áŸ… Database á‘áŸ", "error");
                    return;
                }
                try {
                    await window.rdbUpdate(window.rdbRef(window.db, 'school_cleaning/roster_data'), { attendance: newAttendance });
                } catch (e) {
                    console.error("Save Error:", e);
                    // Show specific error to help debug
                    showNotification("á”ášá¶á‡áŸá™áŸ– " + (e.message || "á˜á·á“áŸáŸ’á‚á¶á›áŸ‹á˜á¼á›á áŸáá»"), "error");
                }
            };

            const saveReasons = async (newReasons) => {
                if (!window.db) return;
                try {
                    await window.rdbUpdate(window.rdbRef(window.db, 'school_cleaning/roster_data'), { reasons: newReasons });
                } catch (e) {
                    console.error("Save Error:", e);
                    showNotification("á”ášá¶á‡áŸá™á€áŸ’á“á»á„á€á¶ášášá€áŸ’áŸá¶á‘á»á€á˜á¼á›á áŸáá»áŸ– " + e.message, "error");
                }
            };

            // Check if libraries are loaded
            useEffect(() => {
                if (window.html2pdf) setIsPdfLibraryReady(true);
                if (window.ExcelJS) setIsExcelLibraryReady(true);
            }, []);

            const changeMonth = (offset) => {
                const newDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + offset, 1);
                setCurrentDate(newDate);
                setSelectedWeek(1);
            };

            const currentKey = `${currentDate.getFullYear()}-${currentDate.getMonth() + 1}-W${selectedWeek}`;
            const weeks = useMemo(() => getWeeksOfMonth(currentDate), [currentDate]);
            const activeWeekInfo = weeks.find(w => w.id === selectedWeek) || weeks[0];

            const toggleStatus = (studentId, status) => {
                setAttendanceData(prev => {
                    const currentWeekData = { ...(prev[currentKey] || {}) };
                    
                    // FIX: If status is 'none' (double click), set to null to delete from Firebase
                    if (status === 'none') {
                        currentWeekData[studentId] = null;
                    } else {
                        currentWeekData[studentId] = status;
                    }

                    const newData = {
                        ...prev,
                        [currentKey]: currentWeekData
                    };
                    saveAttendance(newData); // Save to Firebase
                    return newData;
                });
            };

            const handleReasonChange = (studentId, value) => {
                setAttendanceReasons(prev => {
                    const newData = {
                        ...prev,
                        [currentKey]: {
                            ...(prev[currentKey] || {}),
                            [studentId]: value
                        }
                    };
                    saveReasons(newData); // Save to Firebase
                    return newData;
                });
            };

            const getStatus = (studentId, key = currentKey) => {
                return attendanceData[key]?.[studentId] || 'none';
            };

            const getReason = (studentId, key = currentKey) => {
                return attendanceReasons[key]?.[studentId] || '';
            };

            const getMonthlyStatus = (studentId) => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth() + 1;
                let presentCount = 0;
                let absentOrPermissionCount = 0;

                weeks.forEach(week => {
                const key = `${year}-${month}-W${week.id}`;
                const status = attendanceData[key]?.[studentId]; 
                if (status === 'present') presentCount++;
                if (status === 'absent' || status === 'permission') absentOrPermissionCount++;
                });

                if (presentCount >= 3) {
                return { type: 'good', label: 'áŸá€á˜áŸ’á˜á€á¶ášá„á¶ášá›áŸ’á¢', color: 'text-emerald-700 bg-emerald-50 border-emerald-200', printColor: 'text-emerald-800' };
                }
                if (absentOrPermissionCount >= 2) {
                return { type: 'bad', label: 'á¢áŸá€á˜áŸ’á˜á€á¶ášá„á¶áš', color: 'text-rose-700 bg-rose-50 border-rose-200', printColor: 'text-rose-700' };
                }
                return null;
            };

            const stats = useMemo(() => {
                const currentData = attendanceData[currentKey] || {};
                const values = Object.values(currentData);
                return {
                present: values.filter(v => v === 'present').length,
                permission: values.filter(v => v === 'permission').length,
                absent: values.filter(v => v === 'absent').length,
                total: initialStudents.length
                };
            }, [attendanceData, currentKey, initialStudents.length]);

            const markAllPresent = () => {
                const newWeekData = {};
                initialStudents.forEach(s => newWeekData[s.id] = 'present');
                
                setAttendanceData(prev => {
                    const newData = { ...prev, [currentKey]: newWeekData };
                    saveAttendance(newData);
                    return newData;
                });
                showNotification(`á”á¶á“á€ááŸ‹ááŸ’ášá¶áœááŸ’áá˜á¶á“á‘á¶áŸ†á„á¢áŸáŸ‹!`, 'success');
            };

            const resetCurrentWeek = () => {
                if (window.confirm(`á›á»á”á‘á·á“áŸ’á“á“áŸá™ ${activeWeekInfo.label} á…áŸ„á›?`)) {
                    setAttendanceData(prev => {
                        const newData = { ...prev };
                        delete newData[currentKey];
                        saveAttendance(newData);
                        return newData;
                    });
                    setAttendanceReasons(prev => {
                        const newData = { ...prev };
                        delete newData[currentKey];
                        saveReasons(newData);
                        return newData;
                    });
                    showNotification("á”á¶á“á›á»á”á‘á·á“áŸ’á“á“áŸá™ášá½á…ášá¶á›áŸ‹!", 'error');
                }
            };

            // --- Excel Download Logic ---
            const handleDownloadExcel = async (type = 'weekly') => {
                if (!isExcelLibraryReady || !window.ExcelJS) {
                showNotification("á€áŸ†á–á»á„ášáŸ€á”á…áŸ†á”áŸ’ášá–áŸá“áŸ’á’ Excel... áŸá¼á˜á–áŸ’á™á¶á™á¶á˜á˜áŸ’áŠá„á‘áŸ€á", "error");
                return;
                }

                showNotification(`á€áŸ†á–á»á„á”á„áŸ’á€á¾á Excel ${type === 'weekly' ? 'áŸá”áŸ’áŠá¶á áŸ' : 'á”áŸ’ášá…á¶áŸ†ááŸ‚'}...`, "success");

                try {
                    const workbook = new window.ExcelJS.Workbook();
                    const sheetName = type === 'weekly' ? 'Weekly Report' : 'Monthly Report';
                    const worksheet = workbook.addWorksheet(sheetName);

                    // --- Styles ---
                    const titleFont = { name: 'Khmer OS Muol Light', bold: true, size: 14 }; 
                    const headerFont = { name: 'Khmer OS Battambang', bold: true, size: 11 };
                    const dataFont = { name: 'Khmer OS Battambang', size: 11 };
                    
                    const headerFill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FFFFFF00' } // Yellow
                    };
                    
                    const summaryHeaderFill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FFD9D9D9' } // Light Grey
                    };

                    const borderStyle = {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    };

                    const centerAlign = { vertical: 'middle', horizontal: 'center' };
                    const leftAlign = { vertical: 'middle', horizontal: 'left' };

                    // --- Columns ---
                    let columns = [
                        { key: 'id', width: 8 },
                        { key: 'name', width: 25 },
                    ];

                    let headerRowValues = ['á›.áš', 'áˆáŸ’á˜áŸ„áŸ‡á“á·áŸáŸ’áŸá·á'];

                    if (type === 'weekly') {
                        columns.push(
                            { key: 'status', width: 15 },
                            { key: 'reason', width: 30 }
                        );
                        headerRowValues.push('áŸáŸ’áá¶á“á—á¶á–', 'á•áŸ’áŸáŸá„áŸ— (á˜á¼á›á áŸáá»)');
                    } else {
                        // Monthly Columns
                        weeks.forEach((week) => {
                            columns.push({ key: `w${week.id}`, width: 12 });
                            headerRowValues.push(week.label.replace("áŸá”áŸ’áŠá¶á áŸá‘á¸", "áŸ"));
                        });
                        columns.push(
                            { key: 'total_p', width: 12 },
                            { key: 'total_per', width: 12 },
                            { key: 'total_a', width: 12 },
                            { key: 'result', width: 20 }
                        );
                        headerRowValues.push('áŸášá»á”áœááŸ’áá˜á¶á“', 'áŸášá»á”á…áŸ’á”á¶á”áŸ‹', 'áŸášá»á”á¢áœááŸ’áá˜á¶á“', 'á›á‘áŸ’á’á•á›');
                    }

                    worksheet.columns = columns;

                    // --- 1. Title Row ---
                    const monthStr = formatDateToKhmer(currentDate);
                    const titleText = type === 'weekly' 
                        ? `áá¶ášá¶á„áœáŸá“áŸá˜áŸ’á¢á¶ááŸá¶á›á¶ á‡áŸ†á“á¶á“áŸ‹3 DPA2 - ${monthStr} | ${activeWeekInfo.label}`
                        : `ášá”á¶á™á€á¶ášááŸáŸášá»á”á”áŸ’ášá…á¶áŸ†ááŸ‚ á‡áŸ†á“á¶á“áŸ‹3 DPA2 - ${monthStr}`;

                    worksheet.mergeCells(1, 1, 1, columns.length);
                    const titleRow = worksheet.getRow(1);
                    titleRow.getCell(1).value = titleText;
                    titleRow.height = 30;
                    titleRow.getCell(1).font = titleFont;
                    titleRow.getCell(1).alignment = centerAlign;

                    // --- 2. Header Row ---
                    const headerRow = worksheet.getRow(2);
                    headerRow.values = headerRowValues;
                    headerRow.height = 25;

                    headerRow.eachCell((cell) => {
                        cell.fill = headerFill;
                        cell.font = headerFont;
                        cell.alignment = centerAlign;
                        cell.border = borderStyle;
                    });

                    // Grand Totals
                    let grandTotalPresent = 0;
                    let grandTotalPermission = 0;
                    let grandTotalAbsent = 0;

                    // --- 3. Data Rows ---
                    initialStudents.forEach((student, index) => {
                        const rowData = {
                            id: index + 1,
                            name: student.name
                        };

                        if (type === 'weekly') {
                            const status = getStatus(student.id);
                            let statusText = '';
                            if (status === 'present') { statusText = 'áœááŸ’áá˜á¶á“'; grandTotalPresent++; }
                            else if (status === 'permission') { statusText = 'á…áŸ’á”á¶á”áŸ‹'; grandTotalPermission++; }
                            else if (status === 'absent') { statusText = 'á¢áœááŸ’áá˜á¶á“'; grandTotalAbsent++; }
                            
                            rowData.status = statusText;
                            rowData.reason = getReason(student.id);
                        } else {
                            // Monthly
                            const year = currentDate.getFullYear();
                            const month = currentDate.getMonth() + 1;
                            let p = 0, per = 0, a = 0;

                            weeks.forEach(week => {
                                const key = `${year}-${month}-W${week.id}`;
                                const status = attendanceData[key]?.[student.id];
                                let text = '-';
                                if (status === 'present') { text = 'áœ'; p++; }
                                else if (status === 'permission') { text = 'á…'; per++; }
                                else if (status === 'absent') { text = 'á¢'; a++; }
                                rowData[`w${week.id}`] = text;
                            });

                            rowData.total_p = p;
                            rowData.total_per = per;
                            rowData.total_a = a;

                            grandTotalPresent += p;
                            grandTotalPermission += per;
                            grandTotalAbsent += a;

                            if (p >= 3) rowData.result = "áŸá€á˜áŸ’á˜á€á¶ášá„á¶ášá›áŸ’á¢";
                            else if (per + a >= 2) rowData.result = "á¢áŸá€á˜áŸ’á˜á€á¶ášá„á¶áš";
                            else rowData.result = "";
                        }

                        const row = worksheet.addRow(rowData);

                        row.eachCell((cell, colNumber) => {
                            cell.font = dataFont;
                            cell.border = borderStyle;
                            cell.alignment = { vertical: 'middle', horizontal: colNumber === 2 ? 'left' : 'center' }; 
                            
                            if (type === 'weekly' && colNumber === 3) { 
                                if (cell.value === 'áœááŸ’áá˜á¶á“') cell.font = { ...dataFont, color: { argb: 'FF008000' } };
                                if (cell.value === 'á…áŸ’á”á¶á”áŸ‹') cell.font = { ...dataFont, color: { argb: 'FFFFA500' } };
                                if (cell.value === 'á¢áœááŸ’áá˜á¶á“') cell.font = { ...dataFont, color: { argb: 'FFFF0000' } };
                            }

                            if (type === 'monthly' && colNumber === columns.length) { 
                                if (cell.value === 'áŸá€á˜áŸ’á˜á€á¶ášá„á¶ášá›áŸ’á¢') cell.font = { ...dataFont, color: { argb: 'FF008000' }, bold: true };
                                if (cell.value === 'á¢áŸá€á˜áŸ’á˜á€á¶ášá„á¶áš') cell.font = { ...dataFont, color: { argb: 'FFFF0000' }, bold: true };
                            }
                        });
                    });

                    // --- 4. Summary ---
                    worksheet.addRow([]);
                    const summaryStartRow = worksheet.rowCount + 1;
                    
                    const summaryData = [
                        ['á…áŸ†á“á½á“á“á·áŸáŸ’áŸá·ááŸášá»á”', initialStudents.length],
                        ['áœááŸ’áá˜á¶á“áŸášá»á”', grandTotalPresent],
                        ['á…áŸ’á”á¶á”áŸ‹áŸášá»á”', grandTotalPermission],
                        ['á¢áœááŸ’áá˜á¶á“áŸášá»á”', grandTotalAbsent]
                    ];

                    const summaryHeaderRow = worksheet.addRow(['áŸá„áŸ’ááŸá”á–áŸááŸŒá˜á¶á“ášá½á˜ (Summary)', '']);
                    worksheet.mergeCells(summaryStartRow, 1, summaryStartRow, 2); 
                    
                    const summaryHeaderCell = summaryHeaderRow.getCell(1);
                    summaryHeaderCell.font = { ...headerFont, size: 12 };
                    summaryHeaderCell.fill = summaryHeaderFill;
                    summaryHeaderCell.alignment = leftAlign;
                    summaryHeaderCell.border = borderStyle;

                    summaryData.forEach(item => {
                        const row = worksheet.addRow([item[0], '', item[1]]); 
                        const currentRowNum = row.number;
                        
                        worksheet.mergeCells(currentRowNum, 1, currentRowNum, 2);
                        
                        const labelCell = row.getCell(1);
                        labelCell.font = dataFont;
                        labelCell.border = borderStyle;
                        labelCell.alignment = leftAlign;

                        const valueCell = row.getCell(3);
                        valueCell.font = { ...dataFont, bold: true };
                        valueCell.alignment = centerAlign;
                        valueCell.border = borderStyle;
                    });

                    // --- Save ---
                    const buffer = await workbook.xlsx.writeBuffer();
                    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `Cleaning_Roster_${type}_${new Date().toISOString().slice(0,10)}.xlsx`;
                    link.click();
                    
                    showNotification("á¯á€áŸá¶áš Excel ááŸ’ášá¼áœá”á¶á“á‘á¶á‰á™á€!", "success");

                } catch (err) {
                    console.error("Excel Gen Error:", err);
                    showNotification("á”ášá¶á‡áŸá™á€áŸ’á“á»á„á€á¶ášá”á„áŸ’á€á¾á Excel", "error");
                }
            };

            // --- PDF Download Function ---
            const handleDownloadPDFFile = (type = 'weekly') => {
                if (!isPdfLibraryReady || !window.html2pdf) {
                showNotification("á€áŸ†á–á»á„ášáŸ€á”á…áŸ†á”áŸ’ášá–áŸá“áŸ’á’ PDF... áŸá¼á˜ášá„áŸ‹á…á¶áŸ†á˜á½á™á—áŸ’á›áŸ‚á", "error");
                return;
                }

                setPdfReportType(type);
                setIsPdfGenerating(true);
                showNotification(`á€áŸ†á–á»á„á”á„áŸ’á€á¾áášá”á¶á™á€á¶ášááŸ ${type === 'weekly' ? 'á”áŸ’ášá…á¶áŸ†áŸá”áŸ’áŠá¶á áŸ' : 'á”áŸ’ášá…á¶áŸ†ááŸ‚'}...`, "success");

                setTimeout(() => {
                    const element = document.getElementById('pdf-report-content');
                    const filenameLabel = type === 'weekly' ? `Weekly_${activeWeekInfo.label}` : `Monthly_${currentDate.getMonth() + 1}_${currentDate.getFullYear()}`;
                    
                    const opt = {
                    margin:       0, 
                    filename:     `Cleaning_Roster_${filenameLabel}.pdf`,
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { scale: 2, useCORS: true, letterRendering: true, scrollY: 0 },
                    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
                    pagebreak:    { mode: ['css', 'legacy'] }
                    };

                    window.html2pdf().set(opt).from(element).save()
                    .then(() => {
                        setIsPdfGenerating(false);
                        showNotification("á¯á€áŸá¶áš PDF ááŸ’ášá¼áœá”á¶á“á‘á¶á‰á™á€!", "success");
                    })
                    .catch((err) => {
                        console.error("PDF Generation Error:", err);
                        setIsPdfGenerating(false);
                        showNotification("á˜á¶á“á”á‰áŸ’á á¶á€áŸ’á“á»á„á€á¶ášá”á„áŸ’á€á¾á PDF", "error");
                    });
                }, 1000); 
            };

            const copyToClipboard = () => {
                const monthName = formatDateToKhmer(currentDate);
                let report = `ğŸ“… ášá”á¶á™á€á¶ášááŸáœáŸá“áŸá˜áŸ’á¢á¶ááŸá¶á›á¶\n`;
                report += `ğŸ—“ ${monthName} | ${activeWeekInfo.label} (${activeWeekInfo.range})\n`;
                report += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
                report += `âœ… áœááŸ’áá˜á¶á“: ${stats.present} á“á¶á€áŸ‹\n`;
                report += `ğŸ“ á…áŸ’á”á¶á”áŸ‹: ${stats.permission} á“á¶á€áŸ‹\n`;
                report += `âŒ á¢áœááŸ’áá˜á¶á“: ${stats.absent} á“á¶á€áŸ‹\n`;
                report += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;

                const absentList = initialStudents.filter(s => getStatus(s.id) === 'absent');
                const permissionList = initialStudents.filter(s => getStatus(s.id) === 'permission');

                if (absentList.length > 0) {
                report += `á¢áŸ’á“á€á¢áœááŸ’áá˜á¶á“ (${absentList.length}):\n`;
                absentList.forEach(s => {
                    const reason = getReason(s.id);
                    report += `- ${s.name}${reason ? ` (${reason})` : ''}\n`;
                });
                report += `\n`;
                }
                if (permissionList.length > 0) {
                report += `á¢áŸ’á“á€áŸá»áŸ†á…áŸ’á”á¶á”áŸ‹ (${permissionList.length}):\n`;
                permissionList.forEach(s => {
                    const reason = getReason(s.id);
                    report += `- ${s.name}${reason ? ` (${reason})` : ''}\n`;
                });
                report += `\n`;
                }

                try {
                const textArea = document.createElement("textarea");
                textArea.value = report;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                if (successful) showNotification("á”á¶á“á…á˜áŸ’á›á„ášá”á¶á™á€á¶ášááŸ!", 'success');
                else showNotification("á˜á·á“á¢á¶á…á…á˜áŸ’á›á„á”á¶á“á‘áŸ", 'error');
                } catch (err) {
                showNotification("á˜á¶á“á”á‰áŸ’á á¶á€áŸ’á“á»á„á€á¶ášá…á˜áŸ’á›á„", 'error');
                }
            };

            const showNotification = (msg, type) => {
                setNotification({ msg, type });
                setTimeout(() => setNotification(null), 3000);
            };

            const filteredStudents = initialStudents.filter(s => {
                const matchesSearch = s.name.toLowerCase().includes(searchTerm.toLowerCase());
                const status = getStatus(s.id);
                const matchesFilter = filterStatus === 'all' || 
                                    (filterStatus === 'none' && status === 'none') ||
                                    status === filterStatus;
                return matchesSearch && matchesFilter;
            });

            // --- PDF Pagination Logic ---
            const pdfPages = useMemo(() => {
                const itemsFirstPage = ITEMS_PER_PAGE_FIRST; 
                const itemsOtherPages = ITEMS_PER_PAGE_OTHERS; 
                
                const pages = [];
                
                const page1Data = filteredStudents.slice(0, itemsFirstPage);
                if (page1Data.length > 0) {
                pages.push({ 
                    type: 'first', 
                    items: page1Data, 
                    startIndex: 1 
                });
                }

                let currentIdx = itemsFirstPage;
                while (currentIdx < filteredStudents.length) {
                const chunk = filteredStudents.slice(currentIdx, currentIdx + itemsOtherPages);
                const isLastChunk = (currentIdx + itemsOtherPages) >= filteredStudents.length;
                
                pages.push({ 
                    type: 'standard', 
                    items: chunk, 
                    startIndex: currentIdx + 1,
                    isLast: isLastChunk 
                });
                currentIdx += itemsOtherPages;
                }

                const lastPage = pages[pages.length - 1];
                if (lastPage && lastPage.items.length > 27) {
                pages.push({ type: 'signature_only', items: [] });
                }

                return pages;
            }, [filteredStudents, ITEMS_PER_PAGE_FIRST, ITEMS_PER_PAGE_OTHERS]);

            // --- RENDER ---
            return (
                <div className="min-h-screen bg-slate-50 font-body selection:bg-indigo-100 selection:text-indigo-700">
                    {/* Toast */}
                    {notification && (
                        <div className={`fixed top-6 left-1/2 transform -translate-x-1/2 z-[100] px-4 py-3 rounded-xl shadow-2xl flex items-center gap-2 animate-[fadeIn_0.3s_ease-out] border border-white/20 backdrop-blur-md whitespace-nowrap no-print ${
                        notification.type === 'error' ? 'bg-rose-600 text-white' : 'bg-slate-800 text-white'
                        }`}>
                        {notification.type === 'success' ? <CheckCircle2 size={16} className="text-emerald-400" /> : <AlertCircle size={16} className="text-white" />}
                        <span className="font-display font-medium text-xs md:text-sm">{notification.msg}</span>
                        </div>
                    )}

                    {/* === PDF Hidden Template === */}
                    <div id="pdf-container-wrapper" className={`fixed inset-0 z-[9999] bg-slate-200 flex justify-center items-start overflow-auto p-0 ${isPdfGenerating ? 'block' : 'hidden'}`}>
                        <div id="pdf-report-content" className="w-full max-w-[210mm]">
                            {pdfPages.map((page, pageIndex) => (
                                <div key={pageIndex} className="bg-white text-black w-[210mm] h-[296mm] p-[12mm] mx-auto relative shadow-none flex flex-col" style={{ fontFamily: "'Noto Sans Khmer', sans-serif", pageBreakAfter: pageIndex < pdfPages.length - 1 ? 'always' : 'auto', boxSizing: 'border-box' }}>
                                    
                                    <div className="flex-grow">
                                        {/* Header */}
                                        {page.type === 'first' ? (
                                            <>
                                                <div className="text-center mb-4">
                                                    <h3 className="font-header text-sm md:text-base mb-1">á–áŸ’ášáŸ‡ášá¶á‡á¶áá¶á…á€áŸ’ášá€á˜áŸ’á–á»á‡á¶</h3>
                                                    <h3 className="font-header text-sm md:text-base mb-2">á‡á¶áá· áŸá¶áŸá“á¶ á–áŸ’ášáŸ‡á˜á á¶á€áŸ’áŸááŸ’áš</h3>
                                                    <div className="flex justify-center text-3xl my-1 opacity-80 font-serif">â¦</div>
                                                    <h1 className="font-header text-lg md:text-xl font-bold mt-3 mb-1 text-[#1a237e]">
                                                        {pdfReportType === 'weekly' ? "áá¶ášá¶á„áœáŸá“áŸá˜áŸ’á¢á¶ááŸá¶á›á¶ á‡áŸ†á“á¶á“áŸ‹3 DPA2" : "ášá”á¶á™á€á¶ášááŸáŸášá»á”á”áŸ’ášá…á¶áŸ†ááŸ‚ á‡áŸ†á“á¶á“áŸ‹3 DPA2"}
                                                    </h1>
                                                    <p className="text-sm font-bold text-black mt-1">
                                                        {formatDateToKhmer(currentDate)} {pdfReportType === 'weekly' && ` | ${activeWeekInfo.label}`}
                                                    </p>
                                                    <p className="text-xs text-black">
                                                        {pdfReportType === 'weekly' ? `(${activeWeekInfo.range})` : "(áŸášá»á”á›á‘áŸ’á’á•á›á–áŸá‰á˜á½á™ááŸ‚)"}
                                                    </p>
                                                </div>
                                                {/* Summary Stats PDF */}
                                                {pdfReportType === 'weekly' && (
                                                    <div className="flex justify-center gap-4 mb-6">
                                                        <div className="bg-green-50 border border-green-200 px-4 py-2 rounded text-center min-w-[80px]">
                                                            <span className="block text-xs text-green-700 font-bold mb-1">áœááŸ’áá˜á¶á“</span>
                                                            <span className="text-lg font-bold text-green-800">{stats.present}</span>
                                                        </div>
                                                        <div className="bg-orange-50 border border-orange-200 px-4 py-2 rounded text-center min-w-[80px]">
                                                            <span className="block text-xs text-orange-700 font-bold mb-1">á…áŸ’á”á¶á”áŸ‹</span>
                                                            <span className="text-lg font-bold text-orange-800">{stats.permission}</span>
                                                        </div>
                                                        <div className="bg-red-50 border border-red-200 px-4 py-2 rounded text-center min-w-[80px]">
                                                            <span className="block text-xs text-red-700 font-bold mb-1">á¢áœááŸ’áá˜á¶á“</span>
                                                            <span className="text-lg font-bold text-red-800">{stats.absent}</span>
                                                        </div>
                                                    </div>
                                                )}
                                            </>
                                        ) : page.type === 'signature_only' ? (<div className="h-10"></div>) : (
                                            <div className="text-center mb-4 pt-4 border-b border-indigo-900 pb-2">
                                                <h2 className="font-header text-base font-bold text-[#1a237e]">
                                                    {pdfReportType === 'weekly' ? "áá¶ášá¶á„áœáŸá“áŸá˜áŸ’á¢á¶á (á)" : "ášá”á¶á™á€á¶ášááŸá”áŸ’ášá…á¶áŸ†ááŸ‚ (á)"}
                                                </h2>
                                                <p className="text-xs text-slate-600">
                                                    {pdfReportType === 'weekly' ? `áŸá”áŸ’áŠá¶á áŸá‘á¸ ${activeWeekInfo.label}` : formatDateToKhmer(currentDate)}
                                                </p>
                                            </div>
                                        )}

                                        {/* Table */}
                                        {page.items.length > 0 && (
                                            <div>
                                                <table className="w-full border-collapse border border-gray-300 text-xs">
                                                    <thead>
                                                        <tr className="bg-[#1a237e] text-white">
                                                            <th className="border border-gray-300 p-2 w-8 text-center font-bold">á›.áš</th>
                                                            <th className="border border-gray-300 p-2 text-left font-bold">áˆáŸ’á˜áŸ„áŸ‡á“á·áŸáŸ’áŸá·á</th>
                                                            {pdfReportType === 'monthly' && weeks.map(week => (
                                                                <th key={week.id} className="border border-gray-300 p-2 w-10 text-center font-bold">
                                                                    {week.label.replace("áŸá”áŸ’áŠá¶á áŸá‘á¸", "áŸ")}
                                                                </th>
                                                            ))}
                                                            <th className={`border border-gray-300 p-2 text-center font-bold ${pdfReportType === 'monthly' ? 'w-24' : 'w-28'}`}>áŸáŸ’áá¶á“á—á¶á–</th>
                                                            <th className={`border border-gray-300 p-2 text-center font-bold ${pdfReportType === 'monthly' ? 'w-20' : 'w-32'}`}>á•áŸ’áŸáŸá„áŸ—</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {page.items.map((student, idx) => {
                                                            const realIndex = (page.startIndex || 0) + idx;
                                                            const status = getStatus(student.id);
                                                            const reason = getReason(student.id);
                                                            const monthlyStatus = getMonthlyStatus(student.id);
                                                            const year = currentDate.getFullYear();
                                                            const month = currentDate.getMonth() + 1;
                                                            
                                                            let statusCellContent;
                                                            if (pdfReportType === 'monthly') {
                                                                if (monthlyStatus) {
                                                                    statusCellContent = <span className={`font-bold ${monthlyStatus.printColor}`}>{monthlyStatus.label}</span>;
                                                                } else { statusCellContent = <span className="text-gray-400">-</span>; }
                                                            } else {
                                                                if (status === 'present') statusCellContent = <span className="text-green-700 font-bold">áœááŸ’áá˜á¶á“</span>;
                                                                else if (status === 'permission') statusCellContent = <span className="text-orange-600 font-bold">á…áŸ’á”á¶á”áŸ‹</span>;
                                                                else if (status === 'absent') statusCellContent = <span className="text-red-600 font-bold">á¢áœááŸ’áá˜á¶á“</span>;
                                                                else statusCellContent = <span className="text-gray-400">-</span>;
                                                            }

                                                            return (
                                                                <tr key={student.id} className={idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                                                                    <td className="border border-gray-300 p-1.5 text-center text-black">{realIndex}</td>
                                                                    <td className="border border-gray-300 p-1.5 font-medium text-black px-2">{student.name}</td>
                                                                    {pdfReportType === 'monthly' && weeks.map(week => {
                                                                        const wKey = `${year}-${month}-W${week.id}`;
                                                                        const wStatus = getStatus(student.id, wKey);
                                                                        let symbol = "-";
                                                                        let color = "text-gray-300";
                                                                        if (wStatus === 'present') { symbol = "âœ“"; color = "text-green-600 font-bold"; }
                                                                        else if (wStatus === 'permission') { symbol = "â—"; color = "text-orange-500 font-bold"; }
                                                                        else if (wStatus === 'absent') { symbol = "âœ•"; color = "text-red-600 font-bold"; }
                                                                        return <td key={week.id} className={`border border-gray-300 p-1.5 text-center ${color}`}>{symbol}</td>;
                                                                    })}
                                                                    <td className="border border-gray-300 p-1.5 text-center text-xs">{statusCellContent}</td>
                                                                    <td className="border border-gray-300 p-1.5 text-xs px-2 text-gray-600">{pdfReportType === 'weekly' ? reason : ''}</td>
                                                                </tr>
                                                            );
                                                        })}
                                                    </tbody>
                                                </table>
                                            </div>
                                        )}
                                    </div>

                                    {/* Signature */}
                                    {(pageIndex === pdfPages.length - 1 || page.type === 'signature_only') && (
                                        <div className="mt-8 flex justify-end pr-4">
                                            <div className="text-center w-48">
                                                <p className="text-xs text-black mb-2 font-bold">ášá¶á‡á’á¶á“á¸á—áŸ’á“áŸ†á–áŸá‰, {formatDateToKhmer(new Date(), true)}</p>
                                                <p className="font-header text-sm mt-1 mb-16 font-bold text-black">á¢áŸ’á“á€á€ááŸ‹ááŸ’ášá¶</p>
                                                <div className="border-t border-black w-32 mx-auto"></div>
                                                <p className="text-xs text-black mt-2 font-bold">(áˆáŸ’á˜áŸ„áŸ‡)</p>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* === Mobile View === */}
                    <div className="md:hidden flex flex-col h-screen bg-slate-50 no-print">
                        <div className="bg-gradient-to-r from-indigo-600 to-violet-700 text-white p-4 shadow-md z-20 flex justify-between items-center sticky top-0">
                            <div>
                                <h1 className="font-bold font-display text-lg">áœáŸá“áŸá˜áŸ’á¢á¶ááŸá¶á›á¶</h1>
                                <p className="text-[10px] text-indigo-200">á‡áŸ†á“á¶á“áŸ‹3 DPA2 | {activeWeekInfo.label}</p>
                            </div>
                            <div className="flex gap-1.5">
                                <div className="bg-white/20 backdrop-blur-sm px-2 py-1 rounded-lg text-xs font-bold text-emerald-100 border border-white/10">{stats.present}</div>
                                <div className="bg-white/20 backdrop-blur-sm px-2 py-1 rounded-lg text-xs font-bold text-rose-100 border border-white/10">{stats.absent}</div>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto pb-24 p-3 space-y-3">
                            {activeTab === 'list' && (
                                <>
                                    <div className="flex gap-2 sticky top-0 z-10 bg-slate-50/95 backdrop-blur-sm py-2">
                                        <div className="relative flex-1">
                                            <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4" />
                                            <input type="text" placeholder="áŸáŸ’áœáŸ‚á„ášá€..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full pl-9 pr-2 py-2.5 rounded-xl border border-slate-200 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 shadow-sm" />
                                        </div>
                                        <button onClick={markAllPresent} className="bg-indigo-600 text-white px-3 rounded-xl shadow-sm shadow-indigo-200 flex items-center justify-center"><CheckCircle2 size={18} /></button>
                                    </div>
                                    <div className="space-y-3">
                                        {filteredStudents.map((student) => (
                                            // Mobile Student Card
                                            <div key={student.id} className="bg-white p-3 rounded-xl shadow-sm border border-slate-100">
                                                <div className="flex items-center gap-3 mb-2">
                                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold border ${
                                                        getStatus(student.id) === 'present' ? 'bg-emerald-50 text-emerald-600 border-emerald-200' : 
                                                        getStatus(student.id) === 'absent' ? 'bg-rose-50 text-rose-600 border-rose-200' : 'bg-slate-50 text-slate-500 border-slate-200'
                                                    }`}>{student.id}</div>
                                                    <div>
                                                        <h3 className="font-display font-bold text-slate-800 text-sm">{student.name}</h3>
                                                    </div>
                                                </div>
                                                <div className="grid grid-cols-3 gap-2 mb-2">
                                                    <button onClick={() => toggleStatus(student.id, 'present')} onDoubleClick={() => toggleStatus(student.id, 'none')} className={`py-1.5 rounded-lg flex justify-center ${getStatus(student.id) === 'present' ? 'bg-emerald-500 text-white' : 'bg-slate-100 text-slate-400'}`}><UserCheck size={16}/></button>
                                                    <button onClick={() => toggleStatus(student.id, 'permission')} onDoubleClick={() => toggleStatus(student.id, 'none')} className={`py-1.5 rounded-lg flex justify-center ${getStatus(student.id) === 'permission' ? 'bg-amber-400 text-white' : 'bg-slate-100 text-slate-400'}`}><Clock size={16}/></button>
                                                    <button onClick={() => toggleStatus(student.id, 'absent')} onDoubleClick={() => toggleStatus(student.id, 'none')} className={`py-1.5 rounded-lg flex justify-center ${getStatus(student.id) === 'absent' ? 'bg-rose-500 text-white' : 'bg-slate-100 text-slate-400'}`}><UserX size={16}/></button>
                                                </div>
                                                <input type="text" placeholder="á˜á¼á›á áŸáá»..." value={getReason(student.id)} onChange={(e) => handleReasonChange(student.id, e.target.value)} className="w-full text-xs px-2 py-1.5 rounded border border-slate-200 bg-slate-50 focus:bg-white focus:outline-none" />
                                            </div>
                                        ))}
                                    </div>
                                </>
                            )}
                            
                            {activeTab === 'calendar' && (
                                <div className="space-y-4">
                                    <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 text-center">
                                        <WeekSelector currentDate={currentDate} changeMonth={changeMonth} weeks={weeks} selectedWeek={selectedWeek} setSelectedWeek={setSelectedWeek} />
                                    </div>
                                </div>
                            )}

                            {activeTab === 'report' && (
                                <div className="space-y-4">
                                    <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                                        <h2 className="font-display font-bold text-center mb-4">áŸá„áŸ’ááŸá”ášá”á¶á™á€á¶ášááŸ</h2>
                                        <div className="grid grid-cols-2 gap-2 mb-4">
                                            <div className="bg-emerald-50 p-2 rounded text-center border border-emerald-100"><div className="text-emerald-600 font-bold text-xl">{stats.present}</div><div className="text-xs text-emerald-600">áœááŸ’áá˜á¶á“</div></div>
                                            <div className="bg-amber-50 p-2 rounded text-center border border-amber-100"><div className="text-amber-600 font-bold text-xl">{stats.permission}</div><div className="text-xs text-amber-600">á…áŸ’á”á¶á”áŸ‹</div></div>
                                            <div className="bg-rose-50 p-2 rounded text-center border border-rose-100"><div className="text-rose-600 font-bold text-xl">{stats.absent}</div><div className="text-xs text-rose-600">á¢áœááŸ’áá˜á¶á“</div></div>
                                            <div className="bg-slate-50 p-2 rounded text-center border border-slate-200"><div className="text-slate-600 font-bold text-xl">{stats.total}</div><div className="text-xs text-slate-500">áŸášá»á”</div></div>
                                        </div>
                                        <div className="grid grid-cols-2 gap-2 text-xs">
                                            <button onClick={() => handleDownloadPDFFile('weekly')} className="bg-slate-800 text-white py-2 rounded font-bold flex items-center justify-center gap-1"><Download size={14}/> PDF áŸá”áŸ’áŠá¶á áŸ</button>
                                            <button onClick={() => handleDownloadPDFFile('monthly')} className="bg-blue-800 text-white py-2 rounded font-bold flex items-center justify-center gap-1"><FileBarChart size={14}/> PDF ááŸ‚</button>
                                            <button onClick={() => handleDownloadExcel('weekly')} className="bg-emerald-700 text-white py-2 rounded font-bold flex items-center justify-center gap-1"><FileSpreadsheet size={14}/> Excel áŸá”áŸ’áŠá¶á áŸ</button>
                                            <button onClick={() => handleDownloadExcel('monthly')} className="bg-green-700 text-white py-2 rounded font-bold flex items-center justify-center gap-1"><FileSpreadsheet size={14}/> Excel ááŸ‚</button>
                                        </div>
                                    </div>
                                    <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                                        <button onClick={resetCurrentWeek} className="w-full text-rose-500 py-2 rounded-xl text-sm font-medium flex items-center justify-center gap-2 hover:bg-rose-50"><Trash2 size={16} /> á›á»á”á‘á·á“áŸ’á“á“áŸá™áŸá”áŸ’áŠá¶á áŸá“áŸáŸ‡</button>
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="fixed bottom-0 w-full bg-white border-t border-slate-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] flex justify-around items-center p-2 z-30 pb-safe">
                            <button onClick={() => setActiveTab('list')} className={`flex flex-col items-center gap-1 p-2 rounded-xl w-20 ${activeTab === 'list' ? 'text-indigo-600 font-bold bg-indigo-50' : 'text-slate-400'}`}><Users size={20} /><span className="text-[10px]">á”á‰áŸ’á‡á¸</span></button>
                            <button onClick={() => setActiveTab('calendar')} className={`flex flex-col items-center gap-1 p-2 rounded-xl w-20 ${activeTab === 'calendar' ? 'text-indigo-600 font-bold bg-indigo-50' : 'text-slate-400'}`}><LayoutDashboard size={20} /><span className="text-[10px]">á€á¶á›áœá·á—á¶á‚</span></button>
                            <button onClick={() => setActiveTab('report')} className={`flex flex-col items-center gap-1 p-2 rounded-xl w-20 ${activeTab === 'report' ? 'text-indigo-600 font-bold bg-indigo-50' : 'text-slate-400'}`}><BarChart3 size={20} /><span className="text-[10px]">ášá”á¶á™á€á¶ášááŸ</span></button>
                        </div>
                    </div>

                    {/* === Desktop Layout === */}
                    <div className="hidden md:flex h-screen overflow-hidden no-print">
                        <div className="w-80 bg-white border-r border-slate-200 flex flex-col z-20 shadow-xl">
                            <div className="p-6 bg-gradient-to-br from-indigo-600 to-violet-700 text-white">
                                <h1 className="text-xl font-bold font-display">áœáŸá“áŸá˜áŸ’á¢á¶ááŸá¶á›á¶</h1>
                                <p className="text-xs text-indigo-100 opacity-80 mt-1">á‡áŸ†á“á¶á“áŸ‹3 DPA2</p>
                            </div>
                            <div className="flex-1 overflow-y-auto p-4 space-y-6">
                                <section><h2 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 px-1">á€á¶á›áœá·á—á¶á‚</h2>
                                <WeekSelector currentDate={currentDate} changeMonth={changeMonth} weeks={weeks} selectedWeek={selectedWeek} setSelectedWeek={setSelectedWeek} />
                                </section>
                                <section>
                                    <h2 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 px-1">áŸáŸ’áá·áá·á”áŸ’ášá…á¶áŸ†áŸá”áŸ’áŠá¶á áŸ</h2>
                                    <div className="grid grid-cols-2 gap-2">
                                        <StatCard label="áœááŸ’áá˜á¶á“" value={stats.present} color="text-emerald-600" bg="bg-emerald-100" />
                                        <StatCard label="á…áŸ’á”á¶á”áŸ‹" value={stats.permission} color="text-amber-600" bg="bg-amber-100" />
                                        <StatCard label="á¢áœááŸ’áá˜á¶á“" value={stats.absent} color="text-rose-600" bg="bg-rose-100" />
                                        <StatCard label="áŸášá»á”" value={stats.total} color="text-slate-600" bg="bg-slate-100" />
                                    </div>
                                </section>
                            </div>
                            <div className="p-4 border-t border-slate-100 space-y-2 bg-slate-50">
                                <div className="grid grid-cols-2 gap-2 text-xs">
                                    <button onClick={() => handleDownloadPDFFile('weekly')} className="bg-slate-800 hover:bg-slate-900 text-white py-2.5 rounded-xl font-medium flex flex-col items-center justify-center gap-1 shadow-md"><Download size={14} /> PDF áŸá”áŸ’áŠá¶á áŸ</button>
                                    <button onClick={() => handleDownloadPDFFile('monthly')} className="bg-blue-800 hover:bg-blue-900 text-white py-2.5 rounded-xl font-medium flex flex-col items-center justify-center gap-1 shadow-md"><FileBarChart size={14} /> PDF á”áŸ’ášá…á¶áŸ†ááŸ‚</button>
                                    <button onClick={() => handleDownloadExcel('weekly')} className="bg-emerald-700 hover:bg-emerald-800 text-white py-2.5 rounded-xl font-medium flex flex-col items-center justify-center gap-1 shadow-md"><FileSpreadsheet size={14} /> Excel áŸá”áŸ’áŠá¶á áŸ</button>
                                    <button onClick={() => handleDownloadExcel('monthly')} className="bg-green-700 hover:bg-green-800 text-white py-2.5 rounded-xl font-medium flex flex-col items-center justify-center gap-1 shadow-md"><FileSpreadsheet size={14} /> Excel á”áŸ’ášá…á¶áŸ†ááŸ‚</button>
                                </div>
                                <button onClick={copyToClipboard} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2.5 rounded-xl font-medium flex items-center justify-center gap-2 text-sm shadow-sm"><Copy size={16} /> á…á˜áŸ’á›á„ášá”á¶á™á€á¶ášááŸ</button>
                                <button onClick={resetCurrentWeek} className="w-full bg-white hover:bg-rose-50 text-slate-500 hover:text-rose-600 border border-slate-200 hover:border-rose-200 py-2.5 rounded-xl font-medium flex items-center justify-center gap-2 text-sm"><Trash2 size={16} /> á›á»á”á‘á·á“áŸ’á“á“áŸá™</button>
                            </div>
                        </div>
                        <div className="flex-1 flex flex-col h-screen overflow-hidden bg-slate-50/50">
                            <div className="bg-white/80 backdrop-blur-md border-b border-slate-200 p-4 flex items-center justify-between sticky top-0 z-10">
                                <div className="flex items-center gap-4 flex-1 max-w-lg">
                                    <div className="relative flex-1">
                                        <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4" />
                                        <input type="text" placeholder="áŸáŸ’áœáŸ‚á„ášá€áˆáŸ’á˜áŸ„áŸ‡..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full pl-9 pr-4 py-2 rounded-xl border border-slate-200 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/50 transition-all bg-slate-50 focus:bg-white" />
                                    </div>
                                    <div className="relative">
                                        <Filter className="absolute left-3 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-slate-500" />
                                        <select value={filterStatus} onChange={(e) => setFilterStatus(e.target.value)} className="bg-slate-50 border border-slate-200 rounded-xl pl-8 pr-8 py-2 text-slate-600 focus:ring-2 focus:ring-indigo-500/50 outline-none text-sm font-medium cursor-pointer">
                                            <option value="all">á‘á¶áŸ†á„á¢áŸáŸ‹</option>
                                            <option value="present">áœááŸ’áá˜á¶á“</option>
                                            <option value="permission">á…áŸ’á”á¶á”áŸ‹</option>
                                            <option value="absent">á¢áœááŸ’áá˜á¶á“</option>
                                        </select>
                                    </div>
                                    <button onClick={markAllPresent} className="bg-emerald-50 text-emerald-700 px-3 py-2 rounded-xl text-sm font-medium hover:bg-emerald-100 transition flex items-center gap-2 border border-emerald-100"><CheckCircle2 size={16} /> á˜á€á‘á¶áŸ†á„á¢áŸáŸ‹</button>
                                </div>
                                <div className="text-right">
                                    <h2 className="text-lg font-bold font-display text-slate-800">{activeWeekInfo.label}</h2>
                                    <p className="text-xs text-slate-400">{activeWeekInfo.range}</p>
                                </div>
                            </div>
                            <div className="flex-1 overflow-y-auto p-6">
                                <div className="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4">
                                    {filteredStudents.map((student) => (
                                        <div key={student.id} className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                                            <div className="flex justify-between items-start mb-3">
                                                <div className="flex items-center gap-3">
                                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold border-2 ${getStatus(student.id) === 'present' ? 'bg-emerald-50 text-emerald-600 border-emerald-100' : getStatus(student.id) === 'absent' ? 'bg-rose-50 text-rose-600 border-rose-100' : 'bg-slate-50 text-slate-500 border-slate-100'}`}>{student.id}</div>
                                                    <div>
                                                        <h3 className="font-display font-bold text-slate-800">{student.name}</h3>
                                                        {getMonthlyStatus(student.id) && <span className={`text-[10px] font-bold px-2 py-0.5 rounded-full ${getMonthlyStatus(student.id).color.replace('text-', 'bg-').replace('700', '100')} ${getMonthlyStatus(student.id).color}`}>{getMonthlyStatus(student.id).label}</span>}
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-3 gap-2 mb-3">
                                                <button onClick={() => toggleStatus(student.id, 'present')} onDoubleClick={() => toggleStatus(student.id, 'none')} className={`py-2 rounded-lg flex justify-center ${getStatus(student.id) === 'present' ? 'bg-emerald-500 text-white' : 'bg-slate-50 text-slate-400'}`}><UserCheck size={18}/></button>
                                                <button onClick={() => toggleStatus(student.id, 'permission')} onDoubleClick={() => toggleStatus(student.id, 'none')} className={`py-2 rounded-lg flex justify-center ${getStatus(student.id) === 'permission' ? 'bg-amber-400 text-white' : 'bg-slate-50 text-slate-400'}`}><Clock size={18}/></button>
                                                <button onClick={() => toggleStatus(student.id, 'absent')} onDoubleClick={() => toggleStatus(student.id, 'none')} className={`py-2 rounded-lg flex justify-center ${getStatus(student.id) === 'absent' ? 'bg-rose-500 text-white' : 'bg-slate-50 text-slate-400'}`}><UserX size={18}/></button>
                                            </div>
                                            <input type="text" placeholder="á˜á¼á›á áŸáá»..." value={getReason(student.id)} onChange={(e) => handleReasonChange(student.id, e.target.value)} className="w-full text-xs px-3 py-2 rounded-lg border border-slate-200 bg-slate-50 focus:bg-white focus:outline-none" />
                                        </div>
                                    ))}
                                </div>
                                <div className="h-20"></div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<StudentAttendanceApp />);
    </script>
</body>
</html>
